<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=yes">
    <title>Skype ¬∑ –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Segoe UI WP', 'Segoe UI Symbol', 'Helvetica Neue', sans-serif;
            background: #1b1f24;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            position: relative;
        }

        .log-toggle-btn {
            position: fixed;
            left: 20px;
            bottom: 20px;
            width: 48px;
            height: 48px;
            background: #2d2d2d;
            border: 2px solid #404040;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .log-toggle-btn:hover {
            background: #3d3d3d;
        }

        .log-toggle-btn.active {
            background: #00aff0;
            border-color: #008fc0;
        }

        .log-panel {
            position: fixed;
            left: 20px;
            bottom: 78px;
            width: 500px;
            max-width: calc(100vw - 40px);
            background: #1b1f24;
            border: 2px solid #333333;
            color: #e0e0e0;
            font-family: 'Segoe UI', monospace;
            font-size: 13px;
            z-index: 999;
            display: none;
        }

        .log-panel.visible {
            display: block;
        }

        .log-header {
            background: #2d2d2d;
            padding: 10px 15px;
            border-bottom: 2px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-header span {
            color: white;
            font-weight: 300;
            text-transform: uppercase;
            font-size: 14px;
        }

        .log-close {
            background: none;
            border: 2px solid #555555;
            color: white;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .log-content {
            height: 250px;
            overflow-y: auto;
            padding: 10px;
        }

        .log-line {
            padding: 4px 0;
            border-bottom: 1px solid #333333;
            color: #cccccc;
            font-family: 'Segoe UI', monospace;
            font-size: 12px;
            word-break: break-word;
        }

        .log-line.error { color: #ff8a8a; }
        .log-line.success { color: #90e090; }
        .log-line.warning { color: #ffd966; }

        .log-controls {
            display: flex;
            gap: 2px;
            padding: 10px;
            background: #2d2d2d;
            border-top: 2px solid #404040;
        }

        .log-btn {
            background: #3a3a3a;
            border: 2px solid #4a4a4a;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            font-size: 12px;
            font-weight: 300;
            padding: 8px;
            cursor: pointer;
            flex: 1;
            text-align: center;
            text-transform: uppercase;
        }

        .metro-container {
            width: 1100px;
            max-width: 100%;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            box-shadow: none;
            border: none;
            margin: 0 auto;
        }

        .metro-header {
            background: #00aff0;
            min-height: 60px;
            display: flex;
            align-items: center;
            padding: 10px 20px;
            color: white;
            font-size: 24px;
            font-weight: 300;
            flex-wrap: wrap;
            gap: 10px;
        }

        .metro-header span {
            font-weight: 300;
            text-transform: lowercase;
        }

        .metro-header .header-status {
            margin-left: auto;
            font-size: 14px;
            font-weight: 300;
            opacity: 0.9;
            white-space: nowrap;
        }

        .metro-grid {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            min-height: 600px;
        }

        .metro-tile-profile {
            width: 320px;
            max-width: 100%;
            background: #f0f0f0;
            border-right: 2px solid #d0d0d0;
            padding: 0;
        }

        .metro-tile-logs {
            flex: 1;
            min-width: 300px;
            background: #ffffff;
            display: flex;
            flex-direction: column;
        }

        .tile {
            background: #00aff0;
            color: white;
            padding: 20px 15px;
            margin: 0;
            border-bottom: 2px solid #008fc0;
        }

        .tile-title {
            font-size: 14px;
            font-weight: 300;
            text-transform: uppercase;
            opacity: 0.8;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .tile-content {
            font-size: 22px;
            font-weight: 300;
            word-break: break-all;
            font-family: 'Segoe UI', monospace;
        }

        .tile-content-small {
            font-size: 14px;
            font-weight: 300;
            opacity: 0.9;
        }

        .tile-room {
            background: #2d2d2d;
            color: white;
            padding: 20px 15px;
            border-bottom: 2px solid #404040;
        }

        .metro-input {
            background: #3a3a3a;
            border: 2px solid #555555;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            font-size: 16px;
            padding: 12px;
            width: 100%;
            margin: 8px 0;
            outline: none;
            font-weight: 300;
            -webkit-appearance: none;
            border-radius: 0;
        }

        .metro-input:focus {
            border-color: #00aff0;
            background: #454545;
        }

        .metro-btn {
            background: #00aff0;
            border: 2px solid #008fc0;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            font-size: 16px;
            font-weight: 300;
            padding: 12px 15px;
            margin: 4px 0;
            width: 100%;
            cursor: pointer;
            text-align: left;
            transition: background 0.1s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            -webkit-appearance: none;
            border-radius: 0;
        }

        .metro-btn:hover {
            background: #1fc2ff;
        }

        .metro-btn:active {
            background: #008fc0;
        }

        .metro-btn-green {
            background: #00b050;
            border-color: #009040;
        }

        .metro-btn-red {
            background: #e81123;
            border-color: #c01120;
        }

        .tile-members {
            background: #f0f0f0;
            color: #1b1f24;
            padding: 20px 15px;
            border-bottom: 2px solid #d0d0d0;
        }

        .members-list {
            display: flex;
            flex-wrap: wrap;
            margin-top: 10px;
            gap: 6px;
        }

        .member-badge-metro {
            background: #00aff0;
            color: white;
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 300;
            border: 2px solid #008fc0;
            display: inline-block;
            word-break: break-word;
        }

        .status-bar-metro {
            background: #1b1f24;
            color: white;
            padding: 12px 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            border-bottom: 2px solid #333333;
            font-weight: 300;
        }

        .status-item {
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: #f1c40f;
            margin-right: 8px;
            border: none;
            flex-shrink: 0;
        }

        .status-dot.green { background: #00b050; }
        .status-dot.red { background: #e81123; }
        .status-dot.yellow { background: #f1c40f; }
        .status-dot.gray { background: #7e7e7e; }

        .right-content {
            flex: 1;
            background: #f5f5f5;
            min-height: 200px;
            padding: 20px;
        }

        .audio-test-btn {
            background: #3a3a3a;
            border: 2px solid #555555;
            color: white;
            padding: 10px;
            margin-top: 10px;
            cursor: pointer;
            width: 100%;
            text-align: center;
            font-weight: 300;
        }

        .audio-test-btn:hover {
            background: #4a4a4a;
        }

        .debug-info {
            background: #1b1f24;
            color: #00aff0;
            padding: 8px;
            margin-top: 10px;
            font-size: 12px;
            font-family: monospace;
            border: 2px solid #333333;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .connection-help {
            background: #fff3cd;
            border: 2px solid #856404;
            color: #856404;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            font-weight: 300;
        }

        .audio-players {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .audio-player-item {
            background: #2d2d2d;
            border: 2px solid #404040;
            padding: 10px;
            color: white;
        }

        .audio-player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-weight: 300;
        }

        .audio-player-controls {
            display: flex;
            gap: 8px;
        }

        .audio-play-btn {
            background: #00b050;
            border: 2px solid #009040;
            color: white;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 300;
            text-transform: uppercase;
            font-size: 12px;
        }

        .audio-play-btn:hover {
            background: #20c070;
        }

        .audio-volume {
            width: 100%;
            height: 4px;
            background: #404040;
            margin-top: 8px;
        }

        .audio-volume-fill {
            height: 100%;
            background: #00aff0;
            width: 0%;
            transition: width 0.1s;
        }

        .mic-warning {
            background: #f8d7da;
            border: 2px solid #721c24;
            color: #721c24;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            font-weight: 300;
            display: none;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
                align-items: flex-start;
            }

            .metro-grid {
                flex-direction: column;
            }

            .metro-tile-profile {
                width: 100%;
                border-right: none;
                border-bottom: 2px solid #d0d0d0;
            }

            .metro-tile-logs {
                width: 100%;
            }

            .metro-header {
                font-size: 20px;
                padding: 10px 15px;
            }

            .metro-header .header-status {
                font-size: 12px;
                white-space: normal;
            }

            .tile-content {
                font-size: 18px;
            }

            .status-bar-metro {
                gap: 10px;
            }

            .status-item {
                font-size: 12px;
            }

            .log-toggle-btn {
                left: 10px;
                bottom: 10px;
                width: 44px;
                height: 44px;
                font-size: 18px;
            }

            .log-panel {
                left: 10px;
                bottom: 64px;
                max-width: calc(100vw - 20px);
            }

            .log-content {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <button class="log-toggle-btn" id="logToggleBtn" title="–ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏">üìã</button>

    <div class="log-panel" id="logPanel">
        <div class="log-header">
            <span>—Å–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏</span>
            <button class="log-close" id="logCloseBtn">‚úï</button>
        </div>
        <div class="log-content" id="logContent">
            <div class="log-line">[system] –∑–∞–ø—É—Å–∫...</div>
        </div>
        <div class="log-controls">
            <button class="log-btn" id="copyLogsBtn">–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="log-btn" id="clearLogsBtn">–æ—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
    </div>

    <div class="metro-container">
        <div class="metro-header">
            <span>skype</span>
            <div class="header-status" id="fbStatusText">–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
        </div>

        <div class="metro-grid">
            <div class="metro-tile-profile">
                <div class="tile">
                    <div class="tile-title">–º–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä</div>
                    <div class="tile-content" id="myUserId">–∑–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div class="tile-content-small" style="margin-top: 8px;">–ø–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–∏–º id</div>
                </div>

                <div class="tile-room">
                    <div class="tile-title">–∫–æ–º–Ω–∞—Ç–∞</div>
                    <input type="text" id="roomInput" class="metro-input" placeholder="id –∫–æ–º–Ω–∞—Ç—ã" value="testroom">
                    
                    <button class="metro-btn metro-btn-green" id="joinBtn">–≤–æ–π—Ç–∏</button>
                    <button class="metro-btn metro-btn-red" id="leaveBtn">–ø–æ–∫–∏–Ω—É—Ç—å</button>
                    <button class="metro-btn" id="testMicBtn">—Ç–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</button>
                    
                    <button class="audio-test-btn" id="forceAudioBtn">üîä –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>
                    <button class="audio-test-btn" id="forceReconnectBtn">üîÑ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
                    
                    <div class="connection-help" id="connectionHelp">
                        ‚ö° –µ—Å–ª–∏ –∑–≤—É–∫–∞ –Ω–µ—Ç, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤—ã—à–µ
                    </div>
                    
                    <div class="mic-warning" id="micWarning">
                        ‚ö†Ô∏è –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ –≤—ã –º–æ–∂–µ—Ç–µ —Å–ª—ã—à–∞—Ç—å –¥—Ä—É–≥–∏—Ö
                    </div>
                    
                    <div class="debug-info" id="debugInfo">
                        —Å—Ç–∞—Ç—É—Å: –æ–∂–∏–¥–∞–Ω–∏–µ...
                    </div>
                </div>

                <div class="tile-members">
                    <div class="tile-title">—É—á–∞—Å—Ç–Ω–∏–∫–∏ (<span id="memberCount">0</span>/4)</div>
                    <div id="membersList" class="members-list"></div>
                    <div style="margin-top: 15px; font-weight: 300;">
                        <span class="metro-text-small">—Ç–µ–∫—É—â–∞—è: </span>
                        <span id="currentRoom" style="font-weight: 300;">‚Äî</span>
                    </div>
                </div>
            </div>

            <div class="metro-tile-logs">
                <div class="status-bar-metro">
                    <div class="status-item">
                        <div class="status-dot" id="fbStatus"></div>
                        <span>firebase</span>
                    </div>
                    <div class="status-item">
                        <div class="status-dot" id="micStatus"></div>
                        <span>–º–∏–∫—Ä–æ—Ñ–æ–Ω</span>
                    </div>
                    <div class="status-item">
                        <div class="status-dot" id="peerStatus"></div>
                        <span>–ø–∏—Ä—ã: <span id="peerCount">0</span></span>
                    </div>
                </div>
                
                <div class="right-content">
                    <div style="font-weight: 300; margin-bottom: 15px; color: #1b1f24;">–≤—Ö–æ–¥—è—â–∏–π –∑–≤—É–∫:</div>
                    <div id="audioPlayersContainer" class="audio-players"></div>
                    <div id="noAudioMsg" style="font-weight: 300; color: #666; text-align: center; margin-top: 20px;">–Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫–æ–≤</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDTx2Y9ctiWp26YeMmAHAxDZd_gVI_ZMdw",
            authDomain: "kcalls.firebaseapp.com",
            databaseURL: "https://kcalls-default-rtdb.firebaseio.com",
            projectId: "kcalls",
            storageBucket: "kcalls.firebasestorage.app",
            messagingSenderId: "990117089104",
            appId: "1:990117089104:web:278a42c037e975ebb76655"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const myUserId = 'user_' + Math.random().toString(36).substring(2, 8);
        document.getElementById('myUserId').innerText = myUserId;

        let localStream = null;
        let peers = new Map();
        let currentRoom = null;
        let processingOffers = new Set();
        let isInRoom = false;
        let audioPlayers = new Map();
        let reconnectTimer = null;
        let connectionCheckInterval = null;
        let micAvailable = false;

        const logPanel = document.getElementById('logPanel');
        const logContent = document.getElementById('logContent');
        const logToggleBtn = document.getElementById('logToggleBtn');
        const logCloseBtn = document.getElementById('logCloseBtn');
        const membersList = document.getElementById('membersList');
        const currentRoomSpan = document.getElementById('currentRoom');
        const roomInput = document.getElementById('roomInput');
        const joinBtn = document.getElementById('joinBtn');
        const leaveBtn = document.getElementById('leaveBtn');
        const testMicBtn = document.getElementById('testMicBtn');
        const copyLogsBtn = document.getElementById('copyLogsBtn');
        const clearLogsBtn = document.getElementById('clearLogsBtn');
        const memberCount = document.getElementById('memberCount');
        const peerCount = document.getElementById('peerCount');
        const forceAudioBtn = document.getElementById('forceAudioBtn');
        const forceReconnectBtn = document.getElementById('forceReconnectBtn');
        const debugInfo = document.getElementById('debugInfo');
        const audioPlayersContainer = document.getElementById('audioPlayersContainer');
        const noAudioMsg = document.getElementById('noAudioMsg');
        const micWarning = document.getElementById('micWarning');
        
        const fbStatus = document.getElementById('fbStatus');
        const fbStatusText = document.getElementById('fbStatusText');
        const micStatus = document.getElementById('micStatus');
        const peerStatus = document.getElementById('peerStatus');

        // ------------------------------------------------------------
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ICE —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å TURN –¥–ª—è –æ–±—Ö–æ–¥–∞ NAT
        const iceServers = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' },
                {
                    urls: 'turn:openrelay.metered.ca:80',
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                },
                {
                    urls: 'turn:openrelay.metered.ca:443',
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                },
                {
                    urls: 'turn:openrelay.metered.ca:443?transport=tcp',
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                }
            ],
            iceCandidatePoolSize: 10,
            iceTransportPolicy: 'all'
        };

        // ------------------------------------------------------------
        window.playAudio = async function(userId) {
            log(`—Ä—É—á–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ –∑–≤—É–∫–∞ –¥–ª—è ${userId}`, 'info');
            
            const data = audioPlayers.get(userId);
            if (data && data.element) {
                try {
                    await data.element.play();
                    log(`–∑–≤—É–∫ –≤–∫–ª—é—á–µ–Ω –¥–ª—è ${userId}`, 'success');
                } catch (err) {
                    log(`–æ—à–∏–±–∫–∞: ${err.message}`, 'error');
                }
            }
        };

        // ------------------------------------------------------------
        function updateAudioPlayers() {
            if (audioPlayers.size === 0) {
                audioPlayersContainer.innerHTML = '';
                noAudioMsg.style.display = 'block';
                return;
            }
            
            noAudioMsg.style.display = 'none';
            
            let html = '';
            for (let [userId, data] of audioPlayers) {
                html += `
                    <div class="audio-player-item" id="player_${userId}">
                        <div class="audio-player-header">
                            <span>${userId}</span>
                            <div class="audio-player-controls">
                                <button class="audio-play-btn" onclick="playAudio('${userId}')">‚ñ∂ –≤–∫–ª—é—á–∏—Ç—å</button>
                            </div>
                        </div>
                        <div class="audio-volume" id="volume_${userId}">
                            <div class="audio-volume-fill" id="volumeFill_${userId}"></div>
                        </div>
                    </div>
                `;
            }
            
            audioPlayersContainer.innerHTML = html;
        }

        // ------------------------------------------------------------
        function updateDebugInfo() {
            let info = `–ø–∏—Ä—ã: ${peers.size}\n`;
            info += `–∞—É–¥–∏–æ–ø–ª–µ–µ—Ä—ã: ${audioPlayers.size}\n`;
            info += `—Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${isInRoom ? '–≤ –∫–æ–º–Ω–∞—Ç–µ' : '–≤–Ω–µ –∫–æ–º–Ω–∞—Ç—ã'}\n`;
            info += `–º–∏–∫—Ä–æ—Ñ–æ–Ω: ${micAvailable ? '–¥–æ—Å—Ç—É–ø–µ–Ω' : '–Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω'}\n\n`;
            
            peers.forEach((pc, id) => {
                info += `${id}: ice=${pc.iceConnectionState}, conn=${pc.connectionState}\n`;
            });
            
            debugInfo.innerText = info;
        }

        // ------------------------------------------------------------
        async function forcePlayAllAudio() {
            log('–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ –∑–≤—É–∫–∞...', 'info');
            
            if (audioPlayers.size === 0) {
                log('–Ω–µ—Ç –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä–æ–≤', 'warning');
                return;
            }
            
            let played = 0;
            for (let [userId, data] of audioPlayers) {
                try {
                    if (data.element.paused) {
                        await data.element.play();
                        log(`–∑–≤—É–∫ –≤–∫–ª—é—á–µ–Ω –¥–ª—è ${userId}`, 'success');
                        played++;
                    }
                } catch (err) {
                    log(`–æ—à–∏–±–∫–∞ –¥–ª—è ${userId}: ${err.message}`, 'error');
                }
            }
            
            log(`–≤—Å–µ–≥–æ –≤–∫–ª—é—á–µ–Ω–æ: ${played} –∞—É–¥–∏–æ`, 'info');
            updateDebugInfo();
        }

        // ------------------------------------------------------------
        async function forceReconnect() {
            log('–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'info');
            
            if (!currentRoom || !isInRoom) {
                log('–≤—ã –Ω–µ –≤ –∫–æ–º–Ω–∞—Ç–µ', 'warning');
                return;
            }
            
            const roomId = currentRoom;
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–∏—Ä—ã
            await closeAllPeers();
            
            // –û—á–∏—â–∞–µ–º —Å–≤–æ–∏ —Å–∏–≥–Ω–∞–ª—ã –≤ Firebase
            await db.ref(`rooms/${roomId}/offers/${myUserId}`).remove();
            await db.ref(`rooms/${roomId}/answers/${myUserId}`).remove();
            await db.ref(`rooms/${roomId}/candidates/${myUserId}`).remove();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–π —Å—Ç–∞—Ç—É—Å
            await db.ref(`rooms/${roomId}/members/${myUserId}`).set({
                joined: Date.now()
            });
            
            log('–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–æ', 'success');
        }

        forceAudioBtn.addEventListener('click', forcePlayAllAudio);
        forceReconnectBtn.addEventListener('click', forceReconnect);

        // ------------------------------------------------------------
        logToggleBtn.addEventListener('click', () => {
            logPanel.classList.toggle('visible');
            logToggleBtn.classList.toggle('active');
        });

        logCloseBtn.addEventListener('click', () => {
            logPanel.classList.remove('visible');
            logToggleBtn.classList.remove('active');
        });

        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const line = document.createElement('div');
            line.className = 'log-line';
            if (type === 'error') line.classList.add('error');
            if (type === 'success') line.classList.add('success');
            if (type === 'warning') line.classList.add('warning');
            
            let prefix = '';
            if (type === 'error') prefix = 'ERROR: ';
            else if (type === 'success') prefix = 'OK: ';
            else if (type === 'warning') prefix = 'WARNING: ';
            
            line.innerHTML = `[${time}] ${prefix}${message}`;
            logContent.appendChild(line);
            logContent.scrollTop = logContent.scrollHeight;
            
            if (type === 'error') console.error(message);
            else console.log(message);
        }

        clearLogsBtn.addEventListener('click', () => {
            logContent.innerHTML = '<div class="log-line">[system] –ª–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã</div>';
        });

        copyLogsBtn.addEventListener('click', () => {
            let text = '';
            document.querySelectorAll('#logContent .log-line').forEach(div => {
                text += div.innerText + '\n';
            });
            navigator.clipboard.writeText(text).then(() => {
                log('–ª–æ–≥–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã', 'success');
            });
        });

        // ------------------------------------------------------------
        async function initMic(force = false) {
            if (localStream && !force) {
                micAvailable = true;
                micStatus.className = 'status-dot green';
                micWarning.style.display = 'none';
                return localStream;
            }
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                micAvailable = false;
                micStatus.className = 'status-dot gray';
                micWarning.style.display = 'block';
                log('getUserMedia –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (–±—É–¥–µ—Ç–µ —Ç–æ–ª—å–∫–æ —Å–ª—É—à–∞—Ç—å)', 'warning');
                return null;
            }
            
            try {
                micStatus.className = 'status-dot yellow';
                log('–∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω...');
                
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                micAvailable = true;
                micStatus.className = 'status-dot green';
                micWarning.style.display = 'none';
                log('–º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–ª—É—á–µ–Ω', 'success');
                
                localStream.getTracks().forEach(track => {
                    log(`—Ç—Ä–µ–∫ ${track.kind}: enabled=${track.enabled}`, 'info');
                });
                
                return localStream;
                
            } catch (err) {
                micAvailable = false;
                micStatus.className = 'status-dot gray';
                micWarning.style.display = 'block';
                
                let msg = '–º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω (–±—É–¥–µ—Ç–µ —Ç–æ–ª—å–∫–æ —Å–ª—É—à–∞—Ç—å): ';
                if (err.name === 'NotAllowedError') msg += '–¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω';
                else if (err.name === 'NotFoundError') msg += '–º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω';
                else msg += err.message;
                
                log(msg, 'warning');
                return null;
            }
        }

        testMicBtn.addEventListener('click', async () => {
            const stream = await initMic(true);
            if (stream) {
                log('—Ç–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ —É—Å–ø–µ—à–µ–Ω', 'success');
            } else {
                log('–º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω', 'warning');
            }
        });

        // ------------------------------------------------------------
        async function createPeer(targetId) {
            if (peers.has(targetId)) {
                log(`–∏—Å–ø–æ–ª—å–∑—É—é —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–∏—Ä ${targetId}`, 'info');
                return peers.get(targetId);
            }

            log(`—Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–∏—Ä–∞ –¥–ª—è ${targetId}`, 'info');
            
            const pc = new RTCPeerConnection(iceServers);

            // –î–æ–±–∞–≤–ª—è–µ–º –∞—É–¥–∏–æ—Ç—Ä–µ–∫–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    try {
                        pc.addTrack(track, localStream);
                        log(`—Ç—Ä–µ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è ${targetId}`, 'info');
                    } catch (err) {
                        log(`–æ—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–∞: ${err.message}`, 'error');
                    }
                });
            } else {
                log(`—Å–æ–∑–¥–∞—é –ø–∏—Ä –±–µ–∑ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –¥–ª—è ${targetId} (—Ç–æ–ª—å–∫–æ –ø—Ä–∏–µ–º)`, 'info');
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω—Å–∏–≤–µ—Ä –¥–ª—è –ø—Ä–∏–µ–º–∞ –∞—É–¥–∏–æ
                try {
                    pc.addTransceiver('audio', { direction: 'recvonly' });
                } catch (err) {
                    log(`–æ—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–∏–≤–µ—Ä–∞: ${err.message}`, 'error');
                }
            }

            pc.onicecandidate = (e) => {
                if (e.candidate && currentRoom) {
                    const path = `rooms/${currentRoom}/candidates/${myUserId}/${targetId}`;
                    db.ref(path).push(e.candidate.toJSON())
                        .catch(err => log(`–æ—à–∏–±–∫–∞ ICE: ${err.message}`, 'error'));
                }
            };

            pc.ontrack = (e) => {
                log(`–ø–æ–ª—É—á–µ–Ω –∞—É–¥–∏–æ—Ç—Ä–µ–∫ –æ—Ç ${targetId}`, 'success');
                
                if (audioPlayers.has(targetId)) {
                    try {
                        audioPlayers.get(targetId).element.remove();
                    } catch (err) {}
                }
                
                const audio = new Audio();
                audio.controls = false;
                audio.autoplay = true;
                audio.style.display = 'none';
                audio.srcObject = e.streams[0];
                
                document.body.appendChild(audio);
                
                audioPlayers.set(targetId, {
                    element: audio,
                    stream: e.streams[0]
                });
                
                audio.play()
                    .then(() => log(`–∞—É–¥–∏–æ –æ—Ç ${targetId} –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è`, 'success'))
                    .catch(err => log(`–æ—à–∏–±–∫–∞ –∞–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: ${err.message}`, 'warning'));
                
                updateAudioPlayers();
            };

            pc.oniceconnectionstatechange = () => {
                log(`ice ${targetId}: ${pc.iceConnectionState}`, 'info');
                
                if (pc.iceConnectionState === 'connected') {
                    log(`‚úÖ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${targetId} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ`, 'success');
                    setTimeout(forcePlayAllAudio, 500);
                }
                
                if (pc.iceConnectionState === 'failed' || pc.iceConnectionState === 'disconnected') {
                    log(`–ø—Ä–æ–±–ª–µ–º–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å ${targetId}`, 'warning');
                    
                    if (reconnectTimer) clearTimeout(reconnectTimer);
                    reconnectTimer = setTimeout(() => {
                        if (isInRoom && currentRoom && peers.has(targetId)) {
                            log(`–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ${targetId}...`, 'info');
                            peers.delete(targetId);
                            if (shouldCreateOffer(targetId)) {
                                createOffer(targetId);
                            }
                        }
                    }, 3000);
                }
                
                updatePeerStats();
                updateDebugInfo();
            };

            pc.onconnectionstatechange = () => {
                log(`conn ${targetId}: ${pc.connectionState}`, 'info');
                updatePeerStats();
                updateDebugInfo();
            };

            peers.set(targetId, pc);
            updatePeerStats();
            updateDebugInfo();
            return pc;
        }

        // ------------------------------------------------------------
        async function createOffer(targetId) {
            try {
                const pc = await createPeer(targetId);
                
                const offer = await pc.createOffer({
                    offerToReceiveAudio: true
                });
                await pc.setLocalDescription(offer);
                
                await db.ref(`rooms/${currentRoom}/offers/${myUserId}/${targetId}`).set({
                    type: offer.type,
                    sdp: offer.sdp
                });
                log(`offer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è ${targetId}`, 'success');
                
            } catch (err) {
                log(`–æ—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer: ${err.message}`, 'error');
            }
        }

        // ------------------------------------------------------------
        async function closeAllPeers() {
            for (let [id, pc] of peers) {
                try {
                    pc.close();
                } catch (err) {}
            }
            
            for (let [id, data] of audioPlayers) {
                try {
                    data.element.pause();
                    data.element.remove();
                } catch (err) {}
            }
            
            peers.clear();
            audioPlayers.clear();
            if (reconnectTimer) clearTimeout(reconnectTimer);
            
            updatePeerStats();
            updateDebugInfo();
            updateAudioPlayers();
            log('–≤—Å–µ –ø–∏—Ä—ã –∑–∞–∫—Ä—ã—Ç—ã', 'info');
        }

        // ------------------------------------------------------------
        function shouldCreateOffer(remoteId) {
            return myUserId < remoteId;
        }

        // ------------------------------------------------------------
        function updatePeerStats() {
            let connected = 0;
            for (let pc of peers.values()) {
                if (pc.connectionState === 'connected' || pc.iceConnectionState === 'connected') {
                    connected++;
                }
            }
            peerCount.innerText = `${peers.size} (${connected} —Å–æ–µ–¥.)`;
            
            if (connected > 0) {
                peerStatus.className = 'status-dot green';
            } else if (peers.size > 0) {
                peerStatus.className = 'status-dot yellow';
            } else {
                peerStatus.className = 'status-dot gray';
            }
        }

        // ------------------------------------------------------------
        function startConnectionCheck() {
            if (connectionCheckInterval) clearInterval(connectionCheckInterval);
            
            connectionCheckInterval = setInterval(() => {
                if (!isInRoom || !currentRoom) return;
                
                const memberCount = parseInt(document.getElementById('memberCount').innerText);
                if (memberCount > 1 && peers.size === 0) {
                    log('‚ö†Ô∏è –µ—Å—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∏ –Ω–æ –Ω–µ—Ç –ø–∏—Ä–æ–≤ - –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è', 'warning');
                    forceReconnect();
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –ø–∏—Ä–∞
                peers.forEach((pc, id) => {
                    if (pc.iceConnectionState === 'failed' || pc.iceConnectionState === 'disconnected') {
                        log(`–ø–∏—Ä ${id} –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ ${pc.iceConnectionState}, –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å`, 'warning');
                        peers.delete(id);
                        if (shouldCreateOffer(id)) {
                            createOffer(id);
                        }
                    }
                });
            }, 5000);
        }

        // ------------------------------------------------------------
        async function joinRoom(roomId) {
            if (!roomId) { log('–≤–≤–µ–¥–∏—Ç–µ id –∫–æ–º–Ω–∞—Ç—ã', 'error'); return; }
            
            if (currentRoom) {
                log('—Å–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∏–¥–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–æ–º–Ω–∞—Ç—É', 'warning');
                await leaveRoom();
            }

            // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å
            await initMic().catch(() => {});

            currentRoom = roomId;
            isInRoom = true;
            currentRoomSpan.innerText = roomId;
            log(`–≤—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É: ${roomId}`, 'info');

            await db.ref(`rooms/${roomId}/members/${myUserId}`).set({
                joined: Date.now()
            });

            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
            startConnectionCheck();

            db.ref(`rooms/${roomId}/members`).on('value', (snap) => {
                if (!isInRoom) return;
                
                const members = snap.val() || {};
                const now = Date.now();
                
                const activeMembers = {};
                for (const [uid, data] of Object.entries(members)) {
                    if (data.joined && now - data.joined <= 30000) {
                        activeMembers[uid] = data;
                    }
                }
                
                const userIds = Object.keys(activeMembers);
                
                memberCount.innerText = userIds.length;
                
                membersList.innerHTML = '';
                userIds.forEach(uid => {
                    const span = document.createElement('span');
                    span.className = 'member-badge-metro';
                    span.innerText = uid + (uid === myUserId ? ' (—è)' : '');
                    membersList.appendChild(span);
                });

                log(`—É—á–∞—Å—Ç–Ω–∏–∫–∏: ${userIds.join(', ') || '–Ω–∏–∫–æ–≥–æ'}`, 'info');

                // –°–æ–∑–¥–∞—ë–º –ø–∏—Ä—ã –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
                userIds.forEach(async (uid) => {
                    if (uid === myUserId || !isInRoom) return;
                    
                    if (!peers.has(uid) && shouldCreateOffer(uid)) {
                        log(`–Ω–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ ${uid}, —Å–æ–∑–¥–∞—é offer (—è –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä)`, 'info');
                        await createOffer(uid);
                    }
                });

                // –£–¥–∞–ª—è–µ–º –ø–∏—Ä—ã –≤—ã—à–µ–¥—à–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                for (let uid of peers.keys()) {
                    if (!userIds.includes(uid)) {
                        log(`—É—á–∞—Å—Ç–Ω–∏–∫ ${uid} –≤—ã—à–µ–ª`, 'info');
                        try {
                            peers.get(uid).close();
                            peers.delete(uid);
                            
                            if (audioPlayers.has(uid)) {
                                audioPlayers.get(uid).element.remove();
                                audioPlayers.delete(uid);
                            }
                        } catch (err) {
                            log(`–æ—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–∏—Ä–∞: ${err.message}`, 'error');
                        }
                    }
                }
                
                updatePeerStats();
                updateDebugInfo();
                updateAudioPlayers();
            });

            db.ref(`rooms/${roomId}/offers`).on('child_added', (snap) => {
                if (!isInRoom) return;
                
                const fromUser = snap.key;
                if (fromUser === myUserId) return;
                if (processingOffers.has(fromUser)) return;
                
                const offers = snap.val();
                if (offers && offers[myUserId]) {
                    const offerData = offers[myUserId];
                    log(`–ø–æ–ª—É—á–µ–Ω offer –æ—Ç ${fromUser}`, 'info');
                    processingOffers.add(fromUser);
                    
                    (async () => {
                        try {
                            const pc = await createPeer(fromUser);
                            
                            if (pc.signalingState === 'stable') {
                                await pc.setRemoteDescription(new RTCSessionDescription(offerData));
                                log(`remote description —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è ${fromUser}`, 'success');
                                
                                const answer = await pc.createAnswer();
                                await pc.setLocalDescription(answer);
                                
                                await db.ref(`rooms/${roomId}/answers/${myUserId}/${fromUser}`).set({
                                    type: answer.type,
                                    sdp: answer.sdp
                                });
                                log(`answer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è ${fromUser}`, 'success');
                            }
                            
                        } catch (err) {
                            log(`–æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ offer: ${err.message}`, 'error');
                        } finally {
                            processingOffers.delete(fromUser);
                        }
                    })();
                }
            });

            db.ref(`rooms/${roomId}/answers`).on('child_added', (snap) => {
                if (!isInRoom) return;
                
                const fromUser = snap.key;
                if (fromUser === myUserId) return;
                
                const answers = snap.val();
                if (answers && answers[myUserId]) {
                    const answerData = answers[myUserId];
                    log(`–ø–æ–ª—É—á–µ–Ω answer –æ—Ç ${fromUser}`, 'info');
                    
                    (async () => {
                        try {
                            const pc = peers.get(fromUser);
                            if (pc && pc.signalingState === 'have-local-offer') {
                                await pc.setRemoteDescription(new RTCSessionDescription(answerData));
                                log(`remote answer —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è ${fromUser}`, 'success');
                            }
                        } catch (err) {
                            log(`–æ—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ answer: ${err.message}`, 'error');
                        }
                    })();
                }
            });

            db.ref(`rooms/${roomId}/candidates`).on('child_added', (snap) => {
                if (!isInRoom) return;
                
                const fromUser = snap.key;
                if (fromUser === myUserId) return;
                
                const candidates = snap.val();
                if (candidates && candidates[myUserId]) {
                    Object.values(candidates[myUserId]).forEach(candidateData => {
                        const pc = peers.get(fromUser);
                        if (pc && pc.remoteDescription) {
                            pc.addIceCandidate(new RTCIceCandidate(candidateData))
                                .catch(err => log(`–æ—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ice: ${err.message}`, 'error'));
                        }
                    });
                }
            });

            log('—É—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç—É', 'success');
            updateDebugInfo();
            
            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
            setInterval(() => {
                if (currentRoom && isInRoom) {
                    db.ref(`rooms/${currentRoom}/members/${myUserId}`).update({
                        joined: Date.now()
                    });
                }
            }, 5000);
        }

        // ------------------------------------------------------------
        async function leaveRoom() {
            if (!currentRoom) {
                log('–≤—ã –Ω–µ –≤ –∫–æ–º–Ω–∞—Ç–µ', 'warning');
                return;
            }

            const roomId = currentRoom;
            isInRoom = false;
            
            try {
                await db.ref(`rooms/${roomId}/members/${myUserId}`).remove();
                await db.ref(`rooms/${roomId}/offers/${myUserId}`).remove();
                await db.ref(`rooms/${roomId}/answers/${myUserId}`).remove();
                await db.ref(`rooms/${roomId}/candidates/${myUserId}`).remove();
                
                db.ref(`rooms/${roomId}/members`).off();
                db.ref(`rooms/${roomId}/offers`).off();
                db.ref(`rooms/${roomId}/answers`).off();
                db.ref(`rooms/${roomId}/candidates`).off();
                
                await closeAllPeers();
                processingOffers.clear();
                
                if (connectionCheckInterval) {
                    clearInterval(connectionCheckInterval);
                    connectionCheckInterval = null;
                }
                
                currentRoom = null;
                currentRoomSpan.innerText = '‚Äî';
                membersList.innerHTML = '';
                memberCount.innerText = '0';
                
                log('–≤—ã—à–ª–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã', 'success');
                updateDebugInfo();
                
            } catch (err) {
                log(`–æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ: ${err.message}`, 'error');
            }
        }

        // ------------------------------------------------------------
        db.ref('.info/connected').on('value', (snap) => {
            if (snap.val()) {
                fbStatus.className = 'status-dot green';
                fbStatusText.innerText = '–ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
                log('firebase –ø–æ–¥–∫–ª—é—á–µ–Ω', 'success');
            } else {
                fbStatus.className = 'status-dot red';
                fbStatusText.innerText = '–æ—Ç–∫–ª—é—á–µ–Ω–æ';
                log('firebase –æ—Ç–∫–ª—é—á–µ–Ω', 'error');
            }
        });

        joinBtn.addEventListener('click', () => {
            joinRoom(roomInput.value.trim());
        });

        leaveBtn.addEventListener('click', leaveRoom);

        window.addEventListener('beforeunload', () => {
            if (currentRoom) {
                db.ref(`rooms/${currentRoom}/members/${myUserId}`).remove();
            }
        });

        log(`–≤–∞—à id: ${myUserId}`, 'info');
        updateDebugInfo();
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–±—É–µ–º –≤–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
        setInterval(() => {
            if (isInRoom && audioPlayers.size > 0) {
                forcePlayAllAudio();
            }
        }, 3000);
    </script>
</body>
</html>