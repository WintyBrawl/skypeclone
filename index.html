<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç ¬∑ 4 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ¬∑ —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background: #1e3a5f;
            font-family: 'Segoe UI', system-ui, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 12px;
        }
        .chat-container {
            width: 1000px;
            max-width: 100%;
            background: #d9e8f5;
            border: 3px solid #0a2a44;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 30px rgba(0,0,0,0.5);
        }
        .header {
            background: #1f4a7a;
            color: white;
            padding: 16px 20px;
            font-size: 22px;
            font-weight: 600;
            border-bottom: 3px solid #0d3452;
        }
        .main-grid {
            display: flex;
            flex-wrap: wrap;
        }
        .left-panel {
            width: 300px;
            background: #c8dcf2;
            padding: 20px;
            border-right: 3px solid #6f95bd;
        }
        .right-panel {
            flex: 1;
            background: #e2eefc;
            padding: 20px;
            min-width: 300px;
        }
        .user-card {
            background: #a9c6e9;
            border: 3px solid #2f5f96;
            border-radius: 30px;
            padding: 20px;
            text-align: center;
            margin-bottom: 25px;
        }
        .user-id {
            background: white;
            border: 2px solid #1d4e81;
            border-radius: 40px;
            padding: 15px 10px;
            font-family: monospace;
            font-size: 22px;
            font-weight: bold;
            color: #022c4e;
            word-break: break-all;
            margin-top: 10px;
        }
        .room-section {
            background: #bbd3f0;
            border: 3px solid #386fa8;
            border-radius: 30px;
            padding: 20px;
            margin: 20px 0;
        }
        .input-field {
            width: 100%;
            padding: 15px 18px;
            font-size: 16px;
            border: 3px solid #2d68a0;
            border-radius: 50px;
            background: white;
            margin: 10px 0;
        }
        .btn {
            background: #ecf5ff;
            border: 3px solid #1d5b99;
            border-radius: 50px;
            padding: 15px 20px;
            font-weight: bold;
            font-size: 16px;
            color: #012b50;
            cursor: pointer;
            width: 100%;
            margin: 5px 0;
            box-shadow: 4px 4px 0 #12406b;
            transition: 0.03s;
        }
        .btn:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }
        .btn-green {
            background: #b8e0b8;
            border-color: #1e791e;
            color: #003000;
        }
        .btn-red {
            background: #f5c2c2;
            border-color: #b13d3d;
            color: #480000;
        }
        .members-panel {
            background: #d2e3fc;
            border: 3px solid #3f7ab5;
            border-radius: 30px;
            padding: 20px;
            margin: 15px 0;
        }
        .member-badge {
            display: inline-block;
            background: #2c6ca0;
            color: white;
            border-radius: 40px;
            padding: 8px 16px;
            margin: 5px;
            font-size: 14px;
            border: 2px solid #9bc2f0;
        }
        .log-container {
            background: #0a1e30;
            color: #b3defa;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            padding: 20px;
            border-radius: 20px;
            height: 300px;
            overflow-y: auto;
            border: 3px solid #3f83c1;
            margin: 20px 0;
        }
        .log-line {
            border-bottom: 1px solid #254f77;
            padding: 5px 0;
        }
        .status-indicator {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-bar {
            background: #1f4468;
            color: white;
            padding: 12px;
            border-radius: 30px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
<div class="chat-container">
    <div class="header">
        üéß –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç ¬∑ mesh –¥–æ 4 ¬∑ —Ä–∞–±–æ—á–∞—è –≤–µ—Ä—Å–∏—è
    </div>
    <div class="main-grid">
        <!-- –ª–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="left-panel">
            <div class="user-card">
                <div style="font-size: 18px; color: #022e51;">–º–æ–π ID</div>
                <div class="user-id" id="myUserId">–∑–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>

            <div class="room-section">
                <div style="font-weight: bold; font-size: 18px; margin-bottom: 10px;">üö™ –∫–æ–º–Ω–∞—Ç–∞</div>
                <input type="text" id="roomInput" class="input-field" placeholder="id –∫–æ–º–Ω–∞—Ç—ã" value="testroom">
                <button class="btn btn-green" id="joinBtn">‚ûï –≤–æ–π—Ç–∏</button>
                <button class="btn btn-red" id="leaveBtn">‚úñ –ø–æ–∫–∏–Ω—É—Ç—å</button>
                <button class="btn" id="testMicBtn">üé§ —Ç–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</button>
            </div>

            <div class="members-panel">
                <div style="font-weight: bold; margin-bottom: 15px;">üë• —É—á–∞—Å—Ç–Ω–∏–∫–∏ (<span id="memberCount">0</span>/4)</div>
                <div id="membersList"></div>
                <div style="margin-top: 15px; font-size: 14px;">—Ç–µ–∫—É—â–∞—è: <span id="currentRoom">‚Äî</span></div>
            </div>
        </div>

        <!-- –ø—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –ª–æ–≥–∞–º–∏ -->
        <div class="right-panel">
            <div class="status-bar" id="statusBar">
                <div><span class="status-indicator" id="fbStatus" style="background: #f1c40f;"></span> Firebase: <span id="fbStatusText">–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span></div>
                <div><span class="status-indicator" id="micStatus" style="background: #f1c40f;"></span> –º–∏–∫—Ä–æ—Ñ–æ–Ω: <span id="micStatusText">–Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω</span></div>
                <div><span class="status-indicator" id="peerStatus" style="background: #f1c40f;"></span> –ø–∏—Ä—ã: <span id="peerCount">0</span></div>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button class="btn" id="copyLogsBtn" style="padding: 10px;">üìã –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏</button>
                <button class="btn" id="clearLogsBtn" style="padding: 10px;">üóë –æ—á–∏—Å—Ç–∏—Ç—å</button>
            </div>

            <div id="logPanel" class="log-container">
                <div class="log-line">[system] –∑–∞–ø—É—Å–∫...</div>
            </div>
        </div>
    </div>
</div>

<script>
    // ------------------------------------------------------------
    // FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyDTx2Y9ctiWp26YeMmAHAxDZd_gVI_ZMdw",
        authDomain: "kcalls.firebaseapp.com",
        databaseURL: "https://kcalls-default-rtdb.firebaseio.com",
        projectId: "kcalls",
        storageBucket: "kcalls.firebasestorage.app",
        messagingSenderId: "990117089104",
        appId: "1:990117089104:web:278a42c037e975ebb76655"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ------------------------------------------------------------
    // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
    const myUserId = 'user_' + Math.random().toString(36).substring(2, 8);
    document.getElementById('myUserId').innerText = myUserId;

    let localStream = null;
    let peers = new Map(); // userId -> RTCPeerConnection
    let currentRoom = null;
    let roomMembers = new Set();
    
    // Firebase listeners
    let membersRef = null;
    let offersRef = null;
    let answersRef = null;
    let candidatesRef = null;

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const logPanel = document.getElementById('logPanel');
    const membersList = document.getElementById('membersList');
    const currentRoomSpan = document.getElementById('currentRoom');
    const roomInput = document.getElementById('roomInput');
    const joinBtn = document.getElementById('joinBtn');
    const leaveBtn = document.getElementById('leaveBtn');
    const testMicBtn = document.getElementById('testMicBtn');
    const copyLogsBtn = document.getElementById('copyLogsBtn');
    const clearLogsBtn = document.getElementById('clearLogsBtn');
    const memberCount = document.getElementById('memberCount');
    const peerCount = document.getElementById('peerCount');
    
    // –°—Ç–∞—Ç—É—Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
    const fbStatus = document.getElementById('fbStatus');
    const fbStatusText = document.getElementById('fbStatusText');
    const micStatus = document.getElementById('micStatus');
    const micStatusText = document.getElementById('micStatusText');
    const peerStatus = document.getElementById('peerStatus');

    // ------------------------------------------------------------
    // –õ–û–ì–ò–†–û–í–ê–ù–ò–ï
    function log(message, type = 'info') {
        const time = new Date().toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        const line = document.createElement('div');
        line.className = 'log-line';
        
        let prefix = '‚û°Ô∏è';
        if (type === 'error') prefix = '‚ùå';
        else if (type === 'success') prefix = '‚úÖ';
        else if (type === 'warning') prefix = '‚ö†Ô∏è';
        
        line.innerHTML = `[${time}] ${prefix} ${message}`;
        logPanel.appendChild(line);
        logPanel.scrollTop = logPanel.scrollHeight;
        
        if (type === 'error') console.error(message);
        else console.log(message);
    }

    clearLogsBtn.addEventListener('click', () => {
        logPanel.innerHTML = '<div class="log-line">[system] –ª–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã</div>';
    });

    copyLogsBtn.addEventListener('click', () => {
        let text = '';
        document.querySelectorAll('.log-line').forEach(div => {
            text += div.innerText + '\n';
        });
        navigator.clipboard.writeText(text).then(() => {
            log('–ª–æ–≥–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã', 'success');
        });
    });

    // ------------------------------------------------------------
    // –ú–ò–ö–†–û–§–û–ù
    async function initMic(force = false) {
        if (localStream && !force) {
            micStatus.style.background = '#2ecc71';
            micStatusText.innerText = '–¥–æ—Å—Ç—É–ø–µ–Ω';
            return localStream;
        }
        
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            micStatus.style.background = '#e74c3c';
            micStatusText.innerText = '–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
            log('getUserMedia –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (–Ω—É–∂–µ–Ω HTTPS)', 'error');
            throw new Error('getUserMedia not supported');
        }
        
        try {
            micStatus.style.background = '#f1c40f';
            micStatusText.innerText = '–∑–∞–ø—Ä–æ—Å...';
            log('–∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω...');
            
            localStream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            });
            
            micStatus.style.background = '#2ecc71';
            micStatusText.innerText = '–¥–æ—Å—Ç—É–ø–µ–Ω';
            log('–º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–ª—É—á–µ–Ω', 'success');
            
            localStream.getTracks().forEach(track => {
                log(`—Ç—Ä–µ–∫ ${track.kind}: enabled=${track.enabled}`, 'info');
            });
            
            return localStream;
            
        } catch (err) {
            micStatus.style.background = '#e74c3c';
            micStatusText.innerText = '–æ—à–∏–±–∫–∞';
            
            let msg = '–æ—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: ';
            if (err.name === 'NotAllowedError') msg += '–¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω';
            else if (err.name === 'NotFoundError') msg += '–º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω';
            else msg += err.message;
            
            log(msg, 'error');
            throw err;
        }
    }

    testMicBtn.addEventListener('click', async () => {
        try {
            await initMic(true);
            log('—Ç–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ —É—Å–ø–µ—à–µ–Ω', 'success');
        } catch (err) {
            log('—Ç–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω', 'error');
        }
    });

    // ------------------------------------------------------------
    // –°–û–ó–î–ê–ù–ò–ï –ü–ò–†–ê
    async function createPeer(targetId) {
        if (peers.has(targetId)) {
            log(`–∑–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –ø–∏—Ä ${targetId}`, 'warning');
            peers.get(targetId).close();
            peers.delete(targetId);
        }

        if (!localStream) {
            log('–Ω–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞, –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å', 'warning');
            try { await initMic(); } catch (err) {}
        }

        const pc = new RTCPeerConnection({
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        });

        // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–∫–∏
        if (localStream) {
            localStream.getTracks().forEach(track => {
                try {
                    pc.addTrack(track, localStream);
                    log(`—Ç—Ä–µ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è ${targetId}`, 'info');
                } catch (err) {
                    log(`–æ—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–∞: ${err.message}`, 'error');
                }
            });
        }

        // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
        pc.onicecandidate = (e) => {
            if (e.candidate && currentRoom) {
                const path = `rooms/${currentRoom}/candidates/${myUserId}/${targetId}`;
                db.ref(path).push(e.candidate.toJSON())
                    .then(() => log(`ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–ª—è ${targetId} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω`, 'info'))
                    .catch(err => log(`–æ—à–∏–±–∫–∞ ICE: ${err.message}`, 'error'));
            }
        };

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∞—É–¥–∏–æ
        pc.ontrack = (e) => {
            log(`‚úÖ –ø–æ–ª—É—á–µ–Ω –∞—É–¥–∏–æ—Ç—Ä–µ–∫ –æ—Ç ${targetId}`, 'success');
            
            let audio = document.getElementById(`audio_${targetId}`);
            if (!audio) {
                audio = document.createElement('audio');
                audio.id = `audio_${targetId}`;
                audio.autoplay = true;
                audio.style.display = 'none';
                document.body.appendChild(audio);
            }
            
            audio.srcObject = e.streams[0];
            audio.play().catch(err => log(`–æ—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: ${err.message}`, 'warning'));
        };

        // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        pc.oniceconnectionstatechange = () => {
            log(`ICE ${targetId}: ${pc.iceConnectionState}`, 'info');
            updatePeerStats();
        };

        pc.onconnectionstatechange = () => {
            log(`CONN ${targetId}: ${pc.connectionState}`, 'info');
            updatePeerStats();
        };

        peers.set(targetId, pc);
        updatePeerStats();
        return pc;
    }

    // ------------------------------------------------------------
    // –ó–ê–ö–†–´–¢–¨ –í–°–ï –ü–ò–†–´
    async function closeAllPeers() {
        for (let [id, pc] of peers) {
            try {
                pc.close();
                let audio = document.getElementById(`audio_${id}`);
                if (audio) audio.remove();
            } catch (err) {
                log(`–æ—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–∏—Ä–∞ ${id}: ${err.message}`, 'error');
            }
        }
        peers.clear();
        updatePeerStats();
        log('–≤—Å–µ –ø–∏—Ä—ã –∑–∞–∫—Ä—ã—Ç—ã', 'info');
    }

    // ------------------------------------------------------------
    // –í–•–û–î –í –ö–û–ú–ù–ê–¢–£
    async function joinRoom(roomId) {
        if (!roomId) { log('–≤–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã', 'error'); return; }
        if (currentRoom) { log('—Å–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∏–Ω—å—Ç–µ –∫–æ–º–Ω–∞—Ç—É', 'warning'); return; }

        await initMic().catch(() => {});

        currentRoom = roomId;
        currentRoomSpan.innerText = roomId;
        log(`–≤—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É: ${roomId}`, 'info');

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è
        await db.ref(`rooms/${roomId}/members/${myUserId}`).set({
            joined: Date.now()
        });

        // –°–ª—É—à–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        membersRef = db.ref(`rooms/${roomId}/members`);
        membersRef.on('value', (snap) => {
            const members = snap.val() || {};
            const userIds = Object.keys(members);
            roomMembers = new Set(userIds);
            
            memberCount.innerText = userIds.length;
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
            membersList.innerHTML = '';
            userIds.forEach(uid => {
                const span = document.createElement('span');
                span.className = 'member-badge';
                span.innerText = uid + (uid === myUserId ? ' (—è)' : '');
                membersList.appendChild(span);
            });

            log(`—É—á–∞—Å—Ç–Ω–∏–∫–∏: ${userIds.join(', ') || '–Ω–∏–∫–æ–≥–æ'}`, 'info');

            // –°–æ–∑–¥–∞—ë–º –ø–∏—Ä—ã –¥–ª—è –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            userIds.forEach(async (uid) => {
                if (uid === myUserId) return;
                if (!peers.has(uid)) {
                    log(`–Ω–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ ${uid}, —Å–æ–∑–¥–∞—ë–º offer`, 'info');
                    
                    try {
                        const pc = await createPeer(uid);
                        
                        // –°–æ–∑–¥–∞—ë–º offer
                        const offer = await pc.createOffer({
                            offerToReceiveAudio: true
                        });
                        await pc.setLocalDescription(offer);
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º offer (–ë–ï–ó toJSON, –ø—Ä–æ—Å—Ç–æ –æ–±—ä–µ–∫—Ç)
                        await db.ref(`rooms/${roomId}/offers/${myUserId}/${uid}`).set({
                            type: offer.type,
                            sdp: offer.sdp
                        });
                        log(`offer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è ${uid}`, 'success');
                        
                    } catch (err) {
                        log(`–æ—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer: ${err.message}`, 'error');
                    }
                }
            });

            // –£–¥–∞–ª—è–µ–º –ø–∏—Ä—ã –≤—ã—à–µ–¥—à–∏—Ö
            for (let uid of peers.keys()) {
                if (!userIds.includes(uid)) {
                    log(`—É—á–∞—Å—Ç–Ω–∏–∫ ${uid} –≤—ã—à–µ–ª`, 'info');
                    try {
                        peers.get(uid).close();
                        peers.delete(uid);
                        let audio = document.getElementById(`audio_${uid}`);
                        if (audio) audio.remove();
                    } catch (err) {
                        log(`–æ—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–∏—Ä–∞: ${err.message}`, 'error');
                    }
                }
            }
            updatePeerStats();
        });

        // –°–ª—É—à–∞–µ–º offers
        offersRef = db.ref(`rooms/${roomId}/offers`);
        offersRef.on('child_added', (snap) => {
            const fromUser = snap.key;
            if (fromUser === myUserId) return;
            
            const offers = snap.val();
            if (offers && offers[myUserId]) {
                const offerData = offers[myUserId];
                log(`üìû –ø–æ–ª—É—á–µ–Ω offer –æ—Ç ${fromUser}`, 'info');
                
                (async () => {
                    try {
                        if (!peers.has(fromUser)) {
                            await createPeer(fromUser);
                        }
                        
                        const pc = peers.get(fromUser);
                        
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º remote description
                        await pc.setRemoteDescription(new RTCSessionDescription(offerData));
                        log(`remote description —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è ${fromUser}`, 'success');
                        
                        // –°–æ–∑–¥–∞—ë–º answer
                        const answer = await pc.createAnswer();
                        await pc.setLocalDescription(answer);
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º answer
                        await db.ref(`rooms/${roomId}/answers/${myUserId}/${fromUser}`).set({
                            type: answer.type,
                            sdp: answer.sdp
                        });
                        log(`answer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è ${fromUser}`, 'success');
                        
                    } catch (err) {
                        log(`–æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ offer: ${err.message}`, 'error');
                    }
                })();
            }
        });

        // –°–ª—É—à–∞–µ–º answers
        answersRef = db.ref(`rooms/${roomId}/answers`);
        answersRef.on('child_added', (snap) => {
            const fromUser = snap.key;
            if (fromUser === myUserId) return;
            
            const answers = snap.val();
            if (answers && answers[myUserId]) {
                const answerData = answers[myUserId];
                log(`üìû –ø–æ–ª—É—á–µ–Ω answer –æ—Ç ${fromUser}`, 'info');
                
                (async () => {
                    try {
                        const pc = peers.get(fromUser);
                        if (pc) {
                            await pc.setRemoteDescription(new RTCSessionDescription(answerData));
                            log(`remote answer —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è ${fromUser}`, 'success');
                        } else {
                            log(`–Ω–µ—Ç –ø–∏—Ä–∞ –¥–ª—è ${fromUser}`, 'error');
                        }
                    } catch (err) {
                        log(`–æ—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ answer: ${err.message}`, 'error');
                    }
                })();
            }
        });

        // –°–ª—É—à–∞–µ–º candidates
        candidatesRef = db.ref(`rooms/${roomId}/candidates`);
        candidatesRef.on('child_added', (snap) => {
            const fromUser = snap.key;
            if (fromUser === myUserId) return;
            
            const candidates = snap.val();
            if (candidates && candidates[myUserId]) {
                // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º
                Object.values(candidates[myUserId]).forEach(candidateData => {
                    const pc = peers.get(fromUser);
                    if (pc && pc.remoteDescription) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ remote description —É–∂–µ –µ—Å—Ç—å
                        pc.addIceCandidate(new RTCIceCandidate(candidateData))
                            .then(() => log(`ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω –æ—Ç ${fromUser}`, 'info'))
                            .catch(err => log(`–æ—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE: ${err.message}`, 'error'));
                    } else {
                        log(`ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –ø—Ä–æ–ø—É—â–µ–Ω (–Ω–µ—Ç remote description) –¥–ª—è ${fromUser}`, 'warning');
                    }
                });
            }
        });

        log('‚úÖ —É—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç—É', 'success');
    }

    // ------------------------------------------------------------
    // –í–´–•–û–î –ò–ó –ö–û–ú–ù–ê–¢–´
    async function leaveRoom() {
        if (!currentRoom) {
            log('–≤—ã –Ω–µ –≤ –∫–æ–º–Ω–∞—Ç–µ', 'warning');
            return;
        }

        const roomId = currentRoom;
        
        try {
            // –£–¥–∞–ª—è–µ–º —Å–µ–±—è
            await db.ref(`rooms/${roomId}/members/${myUserId}`).remove();
            
            // –£–¥–∞–ª—è–µ–º —Å–≤–æ–∏ —Å–∏–≥–Ω–∞–ª—ã
            await db.ref(`rooms/${roomId}/offers/${myUserId}`).remove();
            await db.ref(`rooms/${roomId}/answers/${myUserId}`).remove();
            await db.ref(`rooms/${roomId}/candidates/${myUserId}`).remove();
            
            // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è
            if (membersRef) membersRef.off();
            if (offersRef) offersRef.off();
            if (answersRef) answersRef.off();
            if (candidatesRef) candidatesRef.off();
            
            await closeAllPeers();
            
            currentRoom = null;
            currentRoomSpan.innerText = '‚Äî';
            membersList.innerHTML = '';
            memberCount.innerText = '0';
            
            log('üëã –≤—ã—à–ª–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã', 'success');
            
        } catch (err) {
            log(`–æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ: ${err.message}`, 'error');
        }
    }

    // ------------------------------------------------------------
    // –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–ò–°–¢–ò–ö–ò –ü–ò–†–û–í
    function updatePeerStats() {
        let connected = 0;
        for (let pc of peers.values()) {
            if (pc.connectionState === 'connected' || pc.iceConnectionState === 'connected') {
                connected++;
            }
        }
        peerCount.innerText = `${peers.size} (${connected} connected)`;
        
        if (connected > 0) {
            peerStatus.style.background = '#2ecc71';
        } else if (peers.size > 0) {
            peerStatus.style.background = '#f1c40f';
        } else {
            peerStatus.style.background = '#95a5a6';
        }
    }

    // ------------------------------------------------------------
    // FIREBASE –°–¢–ê–¢–£–°
    db.ref('.info/connected').on('value', (snap) => {
        if (snap.val()) {
            fbStatus.style.background = '#2ecc71';
            fbStatusText.innerText = '–ø–æ–¥–∫–ª—é—á–µ–Ω';
            log('Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω', 'success');
        } else {
            fbStatus.style.background = '#e74c3c';
            fbStatusText.innerText = '–æ—Ç–∫–ª—é—á–µ–Ω';
            log('Firebase –æ—Ç–∫–ª—é—á–µ–Ω', 'error');
        }
    });

    // ------------------------------------------------------------
    // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò
    joinBtn.addEventListener('click', () => {
        joinRoom(roomInput.value.trim());
    });

    leaveBtn.addEventListener('click', leaveRoom);

    window.addEventListener('beforeunload', () => {
        if (currentRoom) {
            db.ref(`rooms/${currentRoom}/members/${myUserId}`).remove();
        }
    });

    // ------------------------------------------------------------
    // –°–¢–ê–†–¢
    log(`–≤–∞—à ID: ${myUserId}`, 'info');
</script>
</body>
</html>