<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç ¬∑ 4 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</title>
    <!-- Firebase SDK (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background: #2b3e4f;
            font-family: 'Segoe UI', system-ui, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 12px;
        }
        .chat-container {
            width: 1000px;
            max-width: 100%;
            background: #d9e2ec;
            border: 2px solid #0a3147;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 12px 28px rgba(0,0,0,0.5);
        }
        .header {
            background: #1a4359;
            color: #eaf1f8;
            padding: 16px 20px;
            font-size: 20px;
            font-weight: 600;
            letter-spacing: 0.3px;
            border-bottom: 2px solid #0b2637;
        }
        .main-panels {
            display: flex;
            flex-wrap: wrap;
        }
        .left-panel {
            width: 290px;
            background: #c8d9eb;
            padding: 20px 16px;
            border-right: 2px solid #809bb3;
        }
        .right-panel {
            flex: 1;
            background: #e2ecf7;
            padding: 20px;
            min-width: 280px;
        }
        .info-card {
            background: #b4cef0;
            border: 2px solid #36648b;
            border-radius: 24px;
            padding: 20px 12px;
            text-align: center;
            margin-bottom: 28px;
        }
        .user-id-label {
            font-size: 15px;
            color: #123e5c;
            margin-bottom: 6px;
        }
        .user-id-value {
            background: #ffffff;
            border: 2px solid #1e537b;
            border-radius: 40px;
            padding: 12px 8px;
            font-family: monospace;
            font-size: 20px;
            font-weight: bold;
            color: #02233b;
            word-break: break-all;
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #0a344f;
            margin: 20px 0 12px 0;
            border-bottom: 2px solid #587a9f;
            padding-bottom: 5px;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 8px;
        }
        .input-field {
            padding: 14px 16px;
            font-size: 16px;
            border: 2px solid #2e6291;
            border-radius: 50px;
            background: white;
            outline: none;
        }
        .input-field:focus {
            border-color: #ffb347;
            background: #fffef7;
        }
        .btn {
            background: #eef6ff;
            border: 2px solid #1e5b8e;
            border-radius: 40px;
            padding: 14px 20px;
            font-weight: 600;
            font-size: 16px;
            color: #0f334d;
            cursor: pointer;
            box-shadow: 3px 3px 0 #1b3f61;
            transition: 0.03s linear;
            width: 100%;
        }
        .btn:active {
            transform: translate(3px, 3px);
            box-shadow: none;
        }
        .btn:disabled {
            opacity: 0.4;
            transform: none;
            box-shadow: 3px 3px 0 #1b3f61;
            pointer-events: none;
        }
        .btn-join {
            background: #b9e0b9;
            border-color: #1e6b1e;
            color: #003000;
        }
        .btn-leave {
            background: #f3c2c2;
            border-color: #a13d3d;
            color: #420000;
        }
        .room-panel {
            background: #d5e5fa;
            border: 2px solid #3b6c9c;
            border-radius: 30px;
            padding: 18px;
            margin: 16px 0;
            text-align: center;
        }
        .room-url {
            background: #fff;
            padding: 12px;
            border-radius: 50px;
            border: 1px solid #2565a0;
            font-family: monospace;
            word-break: break-all;
        }
        .log-container {
            background: #102331;
            color: #b4e0ff;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            padding: 18px;
            border-radius: 16px;
            height: 260px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 2px solid #4280b0;
            margin-top: 20px;
        }
        .log-line {
            border-bottom: 1px solid #2f5577;
            padding: 4px 0;
            color: #c5e2ff;
        }
        .log-line.error {
            color: #ffaeae;
        }
        .log-line.warning {
            color: #ffd966;
        }
        .log-line.success {
            color: #a3d8a3;
        }
        .user-badge {
            display: inline-block;
            background: #316e9e;
            color: white;
            border-radius: 40px;
            padding: 6px 14px;
            margin: 4px 6px 4px 0;
            font-size: 14px;
            border: 1px solid #6ea5d4;
        }
        .status-badge {
            background: #4f6b85;
            color: white;
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 14px;
        }
        .member-list {
            margin: 18px 0;
            min-height: 70px;
        }
        .footer-note {
            background: #adc5de;
            padding: 8px 16px;
            font-size: 12px;
            border-top: 2px solid #537a9f;
        }
        .error-box {
            background: #f8d7da;
            border: 2px solid #721c24;
            color: #721c24;
            padding: 12px;
            border-radius: 40px;
            margin: 10px 0;
            font-weight: bold;
        }
        .https-warning {
            background: #fff3cd;
            border: 2px solid #856404;
            color: #856404;
            padding: 8px 12px;
            border-radius: 30px;
            margin: 10px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
<div class="chat-container">
    <div class="header">
        üé§ –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç ¬∑ –º–∞–∫—Å. 4 —É—á–∞—Å—Ç–Ω–∏–∫–∞ ¬∑ –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏
    </div>
    <div class="main-panels">
        <!-- –ª–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –∫–æ–º–Ω–∞—Ç—ã -->
        <div class="left-panel">
            <div class="info-card">
                <div class="user-id-label">–º–æ–π ID (–ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π)</div>
                <div class="user-id-value" id="myUserIdDisplay">–∑–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>

            <div class="section-title">–∫–æ–º–Ω–∞—Ç–∞</div>
            <input type="text" id="roomIdInput" class="input-field" placeholder="id –∫–æ–º–Ω–∞—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: loft)" value="lobby">
            <div style="display: flex; gap: 8px; margin-top: 12px;">
                <button class="btn btn-join" id="joinRoomBtn">‚ûï –≤–æ–π—Ç–∏</button>
                <button class="btn btn-leave" id="leaveRoomBtn">‚úñ –ø–æ–∫–∏–Ω—É—Ç—å</button>
            </div>

            <div class="room-panel">
                <div style="font-weight:600;">—É—á–∞—Å—Ç–Ω–∏–∫–∏ (–¥–æ 4)</div>
                <div id="membersContainer" class="member-list">
                    <span class="status-badge">–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
                </div>
                <div style="font-size:13px; margin-top:8px;">—Ç–µ–∫—É—â–∞—è –∫–æ–º–Ω–∞—Ç–∞: <span id="currentRoomSpan">‚Äî</span></div>
            </div>

            <div id="micStatusPanel" style="font-size:14px; background: #b8d3f0; border-radius: 20px; padding: 10px; margin-top: 10px;">
                <div>üé§ –º–∏–∫—Ä–æ—Ñ–æ–Ω: <span id="micIndicator">‚ö´ –∑–∞–ø—Ä–æ—Å...</span></div>
                <div id="httpsWarning" class="https-warning" style="display: none;">‚ö†Ô∏è –°–∞–π—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ HTTPS (–∏–ª–∏ localhost) –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É</div>
            </div>
        </div>

        <!-- –ø—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –ª–æ–≥–∏, —Å—Ç–∞—Ç—É—Å -->
        <div class="right-panel">
            <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap; margin-bottom: 12px;">
                <span><strong>—Å—Ç–∞—Ç—É—Å:</strong> <span id="connectionIndicator">‚ö™ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</span></span>
                <span><strong>WebRTC:</strong> <span id="webrtcIndicator">‚ö´ –ø—Ä–æ–≤–µ—Ä–∫–∞...</span></span>
            </div>

            <div style="margin-bottom: 10px; font-weight: 600;">üìã —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏ (–æ—à–∏–±–∫–∏, —Å–æ–±—ã—Ç–∏—è)</div>
            <div id="logPanel" class="log-container">
                <div class="log-line">[sys] –æ–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏...</div>
            </div>
            <div style="margin-top: 10px; display: flex; gap: 10px;">
                <button class="btn" id="copyLogBtn">üìã –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏</button>
                <button class="btn" id="clearLogBtn">üóë –æ—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
                <button class="btn" id="testMicBtn">üé§ —Ç–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</button>
            </div>
            <div class="footer-note">
                –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç –Ω–∞ firebase + webrtc (mesh). –¥–ª—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏ –≤ –æ–¥–Ω—É –∫–æ–º–Ω–∞—Ç—É.
                <br>‚ö†Ô∏è –ï—Å–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ HTTPS –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞.
            </div>
        </div>
    </div>
</div>

<script>
    // ------------------------------------------------------------------ 
    // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–∏–∑ –∑–∞–¥–∞–Ω–∏—è)
    const firebaseConfig = {
        apiKey: "AIzaSyDTx2Y9ctiWp26YeMmAHAxDZd_gVI_ZMdw",
        authDomain: "kcalls.firebaseapp.com",
        databaseURL: "https://kcalls-default-rtdb.firebaseio.com",
        projectId: "kcalls",
        storageBucket: "kcalls.firebasestorage.app",
        messagingSenderId: "990117089104",
        appId: "1:990117089104:web:278a42c037e975ebb76655",
        measurementId: "G-TK6GVEX9G5"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // ------------------------------------------------------------------ 
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —É—Ç–∏–ª–∏—Ç—ã
    const myUserId = 'user_' + Math.random().toString(36).substring(2, 8); // –∫–æ—Ä–æ—Ç–∫–∏–π —á–∏—Ç–∞–µ–º—ã–π
    document.getElementById('myUserIdDisplay').innerText = myUserId;

    let localStream = null;
    let peerConnections = {}; // userId -> RTCPeerConnection
    let currentRoom = null;   // –∫–æ–º–Ω–∞—Ç–∞, –≤ –∫–æ—Ç–æ—Ä–æ–π –Ω–∞—Ö–æ–¥–∏–º—Å—è
    let roomMembers = [];      // —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–Ω–∞—Ç—ã (–≤–∫–ª—é—á–∞—è —Å–µ–±—è)
    let micAvailable = false;
    let webrtcSupported = false;

    // —ç–ª–µ–º–µ–Ω—Ç—ã
    const logPanel = document.getElementById('logPanel');
    const connectionIndicator = document.getElementById('connectionIndicator');
    const micIndicator = document.getElementById('micIndicator');
    const webrtcIndicator = document.getElementById('webrtcIndicator');
    const membersContainer = document.getElementById('membersContainer');
    const currentRoomSpan = document.getElementById('currentRoomSpan');
    const joinBtn = document.getElementById('joinRoomBtn');
    const leaveBtn = document.getElementById('leaveRoomBtn');
    const roomIdInput = document.getElementById('roomIdInput');
    const copyLogBtn = document.getElementById('copyLogBtn');
    const clearLogBtn = document.getElementById('clearLogBtn');
    const testMicBtn = document.getElementById('testMicBtn');
    const httpsWarning = document.getElementById('httpsWarning');

    // ------------------------------------------------------------------ 
    // –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (–≤—Å–µ –≤ –ø–∞–Ω–µ–ª—å + console)
    function addLog(message, type = 'info') {
        const time = new Date().toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        const line = document.createElement('div');
        line.className = 'log-line';
        
        let prefix = '‚û°Ô∏è';
        if (type === 'error') prefix = '‚ùå';
        else if (type === 'warning') prefix = '‚ö†Ô∏è';
        else if (type === 'success') prefix = '‚úÖ';
        
        line.innerHTML = `[${time}] ${prefix} ${message}`;
        
        if (type === 'error') line.classList.add('error');
        else if (type === 'warning') line.classList.add('warning');
        else if (type === 'success') line.classList.add('success');
        
        logPanel.appendChild(line);
        logPanel.scrollTop = logPanel.scrollHeight;
        
        if (type === 'error') console.error(message);
        else if (type === 'warning') console.warn(message);
        else console.log(message);
    }

    // –æ—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
    clearLogBtn.addEventListener('click', () => {
        logPanel.innerHTML = '<div class="log-line">[sys] –ª–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã</div>';
        addLog('–ª–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã');
    });

    // –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–æ–≤
    copyLogBtn.addEventListener('click', () => {
        let logText = '';
        document.querySelectorAll('.log-line').forEach(div => {
            logText += div.innerText + '\n';
        });
        navigator.clipboard.writeText(logText).then(() => {
            addLog('–ª–æ–≥–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä', 'success');
        }).catch(() => addLog('–Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å', 'error'));
    });

    // ------------------------------------------------------------------ 
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ WebRTC –∏ HTTPS
    function checkWebRTCSupport() {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ getUserMedia
        const isSecure = window.isSecureContext;
        const gdmSupported = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
        const rtcSupported = !!(window.RTCPeerConnection || window.webkitRTCPeerConnection || window.mozRTCPeerConnection);
        
        webrtcSupported = gdmSupported && rtcSupported;
        
        if (!isSecure) {
            httpsWarning.style.display = 'block';
            addLog('‚ö†Ô∏è –°–∞–π—Ç –æ—Ç–∫—Ä—ã—Ç –Ω–µ –ø–æ HTTPS ‚Äî –º–∏–∫—Ä–æ—Ñ–æ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'warning');
        }
        
        if (!gdmSupported) {
            addLog('‚ùå navigator.mediaDevices.getUserMedia –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º', 'error');
        }
        
        if (!rtcSupported) {
            addLog('‚ùå RTCPeerConnection –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º', 'error');
        }
        
        webrtcIndicator.innerHTML = webrtcSupported ? 'üü¢ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è' : 'üî¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
        
        return webrtcSupported;
    }

    // ------------------------------------------------------------------ 
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
    async function initMicrophone(force = false) {
        if (localStream && !force) {
            addLog('–º–∏–∫—Ä–æ—Ñ–æ–Ω —É–∂–µ –¥–æ—Å—Ç—É–ø–µ–Ω', 'success');
            return localStream;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            const errorMsg = 'navigator.mediaDevices.getUserMedia –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–∞–π—Ç –æ—Ç–∫—Ä—ã—Ç –ø–æ HTTPS.';
            addLog(errorMsg, 'error');
            micIndicator.innerHTML = '‚ùå –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
            throw new Error(errorMsg);
        }
        
        try {
            addLog('–∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
            micIndicator.innerHTML = '‚è≥ –∑–∞–ø—Ä–æ—Å...';
            
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
            localStream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }, 
                video: false 
            });
            
            micAvailable = true;
            micIndicator.innerHTML = 'üé§ –¥–æ—Å—Ç—É–ø–µ–Ω (‚úÖ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ)';
            addLog('‚úÖ –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–ª—É—á–µ–Ω, –∞—É–¥–∏–æ—Ç—Ä–µ–∫–∏ –≥–æ—Ç–æ–≤—ã', 'success');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç—Ä–µ–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            localStream.getTracks().forEach(track => {
                addLog(`  - —Ç—Ä–µ–∫: ${track.kind}, enabled: ${track.enabled}, muted: ${track.muted}`, 'info');
            });
            
            return localStream;
            
        } catch (err) {
            micAvailable = false;
            micIndicator.innerHTML = '‚ùå –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞';
            
            // –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–µ
            let errorMessage = '–æ—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: ';
            if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                errorMessage += '–¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º';
            } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                errorMessage += '–º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω';
            } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                errorMessage += '–º–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º';
            } else if (err.name === 'OverconstrainedError') {
                errorMessage += '–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è';
            } else if (err.name === 'TypeError') {
                errorMessage += '–Ω–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞';
            } else {
                errorMessage += err.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
            }
            
            addLog(errorMessage, 'error');
            addLog(`–¥–µ—Ç–∞–ª–∏: ${err.name} ‚Äî ${err.message}`, 'error');
            
            // –î–ª—è Safari –¥–æ–±–∞–≤–∏–º –ø–æ–¥—Å–∫–∞–∑–∫—É
            if (/Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent)) {
                addLog('üí° Safari: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö (Preferences > Websites > Microphone)', 'warning');
            }
            
            throw err;
        }
    }

    // –¢–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
    testMicBtn.addEventListener('click', async () => {
        try {
            await initMicrophone(true);
            addLog('‚úÖ —Ç–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –ø—Ä–æ–π–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –∑–≤—É–∫–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            if (localStream) {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(localStream);
                source.connect(analyser);
                addLog('üé§ –∞—É–¥–∏–æ–∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Å–æ–∑–¥–∞–Ω, –º–æ–∂–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç—å...', 'info');
                
                // –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –æ—Ç–∫–ª—é—á–∞–µ–º
                setTimeout(() => {
                    source.disconnect();
                    audioContext.close();
                }, 2000);
            }
        } catch (err) {
            addLog('‚ùå —Ç–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω', 'error');
        }
    });

    // ------------------------------------------------------------------ 
    // –°–æ–∑–¥–∞–Ω–∏–µ peer connection –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function createPeerConnection(targetUserId) {
        if (peerConnections[targetUserId]) {
            addLog(`–ø–∏—Ä ${targetUserId} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π`, 'warning');
            peerConnections[targetUserId].close();
            delete peerConnections[targetUserId];
        }

        if (!localStream) {
            addLog('–Ω–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞, –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω', 'warning');
            try {
                await initMicrophone();
            } catch (err) {
                addLog('–Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω, —Å–æ–∑–¥–∞—ë–º peer –±–µ–∑ –∞—É–¥–∏–æ', 'error');
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å, –¥—Ä—É–≥–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –±—É–¥–µ—Ç –≥–æ–≤–æ—Ä–∏—Ç—å)
            }
        }

        const pc = new RTCPeerConnection({
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' }
            ]
        });

        // –¥–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        if (localStream) {
            localStream.getTracks().forEach(track => {
                try {
                    pc.addTrack(track, localStream);
                    addLog(`–¥–æ–±–∞–≤–ª–µ–Ω —Ç—Ä–µ–∫ ${track.kind} –¥–ª—è ${targetUserId}`, 'info');
                } catch (e) {
                    addLog(`–æ—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–∞: ${e.message}`, 'error');
                }
            });
        } else {
            addLog(`–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ª–æ–∫–∞–ª—å–Ω—ã–π —Å—Ç—Ä–∏–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–ª—è ${targetUserId}`, 'warning');
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π –∞—É–¥–∏–æ—Ç—Ä–µ–∫? –ù–µ—Ç, –ø—Ä–æ—Å—Ç–æ –±–µ–∑ —Ç—Ä–µ–∫–æ–≤
        }

        // –æ—Ç–ø—Ä–∞–≤–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –≤ firebase
        pc.onicecandidate = (e) => {
            if (e.candidate && currentRoom) {
                const candidatePath = `rooms/${currentRoom}/candidates/${myUserId}/${targetUserId}`;
                database.ref(candidatePath).push(e.candidate.toJSON())
                    .then(() => addLog(`–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–ª—è ${targetUserId}`, 'info'))
                    .catch(err => addLog(`–æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞: ${err.message}`, 'error'));
            }
        };

        pc.ontrack = (e) => {
            addLog(`‚úÖ –ø–æ–ª—É—á–µ–Ω –∞—É–¥–∏–æ—Ç—Ä–µ–∫ –æ—Ç ${targetUserId}`, 'success');
            
            // —Å–æ–∑–¥–∞—ë–º —Å–∫—Ä—ã—Ç—ã–π audio –∏ –ø–æ–¥–∫–ª—é—á–∞–µ–º
            let audioEl = document.getElementById(`audio_${targetUserId}`);
            if (!audioEl) {
                audioEl = document.createElement('audio');
                audioEl.id = `audio_${targetUserId}`;
                audioEl.autoplay = true;
                audioEl.controls = false;
                audioEl.style.display = 'none';
                document.body.appendChild(audioEl);
                addLog(`—Å–æ–∑–¥–∞–Ω –∞—É–¥–∏–æ—ç–ª–µ–º–µ–Ω—Ç –¥–ª—è ${targetUserId}`, 'info');
            }
            
            try {
                audioEl.srcObject = e.streams[0];
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º (–¥–ª—è Safari)
                audioEl.play().catch(err => addLog(`–æ—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: ${err.message}`, 'warning'));
            } catch (err) {
                addLog(`–æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫–∞: ${err.message}`, 'error');
            }
        };

        pc.oniceconnectionstatechange = () => {
            addLog(`[ice state with ${targetUserId}] ${pc.iceConnectionState}`, 'info');
            if (pc.iceConnectionState === 'disconnected' || pc.iceConnectionState === 'failed') {
                // –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                addLog(`—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${targetUserId} –ø–æ—Ç–µ—Ä—è–Ω–æ`, 'warning');
            }
        };

        pc.onconnectionstatechange = () => {
            addLog(`[connection state with ${targetUserId}] ${pc.connectionState}`, 'info');
        };

        peerConnections[targetUserId] = pc;
        addLog(`peerConnection —Å–æ–∑–¥–∞–Ω –¥–ª—è ${targetUserId}`, 'success');
        return pc;
    }

    // ------------------------------------------------------------------ 
    // –ó–∞–∫—Ä—ã—Ç—å –≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    async function closeAllPeers() {
        for (let uid of Object.keys(peerConnections)) {
            try {
                peerConnections[uid].close();
                delete peerConnections[uid];
                
                // —É–¥–∞–ª—è–µ–º –∞—É–¥–∏–æ—ç–ª–µ–º–µ–Ω—Ç—ã
                const audioEl = document.getElementById(`audio_${uid}`);
                if (audioEl) audioEl.remove();
            } catch (err) {
                addLog(`–æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–∏—Ä–∞ ${uid}: ${err.message}`, 'error');
            }
        }
        peerConnections = {};
        addLog('–≤—Å–µ –ø–∏—Ä—ã –∑–∞–∫—Ä—ã—Ç—ã', 'info');
    }

    // ------------------------------------------------------------------ 
    // –í—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É
    async function joinRoom(roomId) {
        if (!roomId) { 
            addLog('–ø—É—Å—Ç–æ–π id –∫–æ–º–Ω–∞—Ç—ã', 'error'); 
            return; 
        }
        
        if (currentRoom) {
            addLog(`—É–∂–µ –≤ –∫–æ–º–Ω–∞—Ç–µ ${currentRoom}, —Å–Ω–∞—á–∞–ª–∞ –≤—ã–π–¥–∏—Ç–µ`, 'error');
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É WebRTC
        if (!webrtcSupported) {
            addLog('WebRTC –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º ‚Äî –≥–æ–ª–æ—Å–æ–≤–∞—è —Å–≤—è–∑—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞', 'error');
        }

        // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω, –Ω–æ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
        try {
            await initMicrophone();
        } catch (err) {
            addLog('–ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ (–≤—ã —Å–º–æ–∂–µ—Ç–µ —Å–ª—ã—à–∞—Ç—å –¥—Ä—É–≥–∏—Ö)', 'warning');
        }

        currentRoom = roomId;
        currentRoomSpan.innerText = roomId;
        addLog(`–ø–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ –≤ –∫–æ–º–Ω–∞—Ç—É: ${roomId}`, 'info');

        // —Å—Å—ã–ª–∫–∞ –Ω–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–Ω–∞—Ç—ã
        const membersRef = database.ref(`rooms/${roomId}/members`);
        
        // –∞—Ç–æ–º–∞—Ä–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è —Å timestamp
        await membersRef.child(myUserId).set({ 
            joined: Date.now(),
            userAgent: navigator.userAgent.substring(0, 50)
        });

        // —Å–ª—É—à–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        membersRef.on('value', (snap) => {
            const members = snap.val() || {};
            const userIds = Object.keys(members);
            roomMembers = userIds;
            addLog(`–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${userIds.join(', ') || '–Ω–∏–∫–æ–≥–æ'}`, 'info');

            // –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º
            membersContainer.innerHTML = '';
            userIds.forEach(uid => {
                const span = document.createElement('span');
                span.className = 'user-badge';
                span.innerText = uid + (uid === myUserId ? ' (—è)' : '');
                membersContainer.appendChild(span);
            });

            // –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ (–¥–æ 4)
            if (userIds.length > 4) {
                addLog('‚ö†Ô∏è –ø—Ä–µ–≤—ã—à–µ–Ω–æ 4 —É—á–∞—Å—Ç–Ω–∏–∫–∞, –Ω–æ –≤—Å—ë –µ—â—ë —Ä–∞–±–æ—Ç–∞–µ–º mesh', 'warning');
            }

            // –∑–∞–ø—É—Å–∫–∞–µ–º –ø–∏—Ä–∏–Ω–≥ –¥–ª—è –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–∏—Å–∫–ª—é—á–∞—è —Å–µ–±—è)
            userIds.forEach(async (uid) => {
                if (uid === myUserId) return;
                
                // –µ—Å–ª–∏ –µ—â—ë –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è ‚Äî –∏–Ω–∏—Ü–∏–∏—Ä—É–µ–º
                if (!peerConnections[uid]) {
                    addLog(`–Ω–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ ${uid}, —Å–æ–∑–¥–∞—ë–º offer`, 'info');
                    
                    try {
                        const pc = await createPeerConnection(uid);
                        
                        // —Å–æ–∑–¥–∞—ë–º offer –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
                        const offer = await pc.createOffer({
                            offerToReceiveAudio: true,
                            voiceActivityDetection: true
                        });
                        await pc.setLocalDescription(offer);
                        
                        // —Å–æ—Ö—Ä–∞–Ω—è–µ–º offer –≤ –∫–æ–º–Ω–∞—Ç–µ
                        await database.ref(`rooms/${roomId}/offers/${myUserId}/${uid}`).set(offer);
                        addLog(`offer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è ${uid}`, 'success');
                    } catch (err) {
                        addLog(`–æ—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer –¥–ª—è ${uid}: ${err.message}`, 'error');
                    }
                }
            });

            // —á–∏—Å—Ç–∏–º –ø–∏—Ä—ã, –∫—Ç–æ –≤—ã—à–µ–ª
            Object.keys(peerConnections).forEach(uid => {
                if (!userIds.includes(uid)) {
                    addLog(`—É—á–∞—Å—Ç–Ω–∏–∫ ${uid} –ø–æ–∫–∏–Ω—É–ª, –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–∏—Ä`, 'info');
                    try {
                        peerConnections[uid].close();
                        delete peerConnections[uid];
                        const audioEl = document.getElementById(`audio_${uid}`);
                        if (audioEl) audioEl.remove();
                    } catch (err) {
                        addLog(`–æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–∏—Ä–∞ ${uid}: ${err.message}`, 'error');
                    }
                }
            });
        });

        // —Å–ª—É—à–∞–µ–º offers (–æ—Ç–≤–µ—Ç—ã –∏ answer)
        const offersRef = database.ref(`rooms/${roomId}/offers`);
        offersRef.on('child_added', (snap) => {
            const fromUser = snap.key; // –∫—Ç–æ —Å–æ–∑–¥–∞–ª offer (remote)
            if (fromUser === myUserId) return;
            
            const offersForMe = snap.val();
            if (offersForMe && offersForMe[myUserId]) {
                // —ç—Ç–æ offer, –∞–¥—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã–π –º–Ω–µ
                const offer = offersForMe[myUserId];
                addLog(`üìû –ø–æ–ª—É—á–µ–Ω offer –æ—Ç ${fromUser} –¥–ª—è –º–µ–Ω—è`, 'info');
                
                (async () => {
                    try {
                        if (!peerConnections[fromUser]) {
                            await createPeerConnection(fromUser);
                        }
                        const pc = peerConnections[fromUser];
                        
                        await pc.setRemoteDescription(new RTCSessionDescription(offer));
                        addLog(`remote description —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è ${fromUser}`, 'success');
                        
                        const answer = await pc.createAnswer();
                        await pc.setLocalDescription(answer);
                        
                        // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º answer –æ–±—Ä–∞—Ç–Ω–æ
                        await database.ref(`rooms/${roomId}/answers/${myUserId}/${fromUser}`).set(answer);
                        addLog(`answer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è ${fromUser}`, 'success');
                        
                    } catch (err) {
                        addLog(`–æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ offer –æ—Ç ${fromUser}: ${err.message}`, 'error');
                        addLog(`—Å—Ç–µ–∫: ${err.stack}`, 'error');
                    }
                })();
            }
        });

        // —Å–ª—É—à–∞–µ–º answers
        const answersRef = database.ref(`rooms/${roomId}/answers`);
        answersRef.on('child_added', (snap) => {
            const fromUser = snap.key; // –∫—Ç–æ –¥–∞—ë—Ç answer (remote)
            if (fromUser === myUserId) return;
            
            const answersForMe = snap.val();
            if (answersForMe && answersForMe[myUserId]) {
                const answer = answersForMe[myUserId];
                addLog(`üìû –ø–æ–ª—É—á–µ–Ω answer –æ—Ç ${fromUser}`, 'info');
                
                (async () => {
                    try {
                        const pc = peerConnections[fromUser];
                        if (pc) {
                            await pc.setRemoteDescription(new RTCSessionDescription(answer));
                            addLog(`remote answer —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è ${fromUser}`, 'success');
                        } else {
                            addLog(`–Ω–µ—Ç peer –¥–ª—è ${fromUser} –ø—Ä–∏ answer`, 'error');
                        }
                    } catch (err) {
                        addLog(`–æ—à–∏–±–∫–∞ answer –æ—Ç ${fromUser}: ${err.message}`, 'error');
                    }
                })();
            }
        });

        // —Å–ª—É—à–∞–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
        const candidatesRef = database.ref(`rooms/${roomId}/candidates`);
        candidatesRef.on('child_added', (snap) => {
            const fromUser = snap.key; // –∫—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
            if (fromUser === myUserId) return;
            
            const candidatesToMe = snap.val();
            if (candidatesToMe && candidatesToMe[myUserId]) {
                // candidatesToMe[myUserId] –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º —Å pushId
                Object.values(candidatesToMe[myUserId]).forEach(candidateData => {
                    if (peerConnections[fromUser]) {
                        peerConnections[fromUser].addIceCandidate(new RTCIceCandidate(candidateData))
                            .then(() => addLog(`ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω –æ—Ç ${fromUser}`, 'info'))
                            .catch(e => addLog(`–æ—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE: ${e.message}`, 'error'));
                    }
                });
            }
        });

        connectionIndicator.innerHTML = 'üü¢ –≤ –∫–æ–º–Ω–∞—Ç–µ';
        addLog(`‚úÖ —É—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç—É ${roomId}`, 'success');
    }

    // –ø–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É
    async function leaveRoom() {
        if (!currentRoom) {
            addLog('–≤—ã –Ω–µ –≤ –∫–æ–º–Ω–∞—Ç–µ', 'error');
            return;
        }
        
        const roomId = currentRoom;
        
        try {
            // —É–¥–∞–ª—è–µ–º —Å–µ–±—è –∏–∑ members
            await database.ref(`rooms/${roomId}/members/${myUserId}`).remove();
            
            // –æ—á–∏—Å—Ç–∏–º offers/answers/candidates
            await database.ref(`rooms/${roomId}/offers/${myUserId}`).remove();
            await database.ref(`rooms/${roomId}/answers/${myUserId}`).remove();
            await database.ref(`rooms/${roomId}/candidates/${myUserId}`).remove();

            // –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–∏—Ä—ã
            await closeAllPeers();
            
            currentRoom = null;
            currentRoomSpan.innerText = '‚Äî';
            membersContainer.innerHTML = '<span class="status-badge">–Ω–µ—Ç –≤ –∫–æ–º–Ω–∞—Ç–µ</span>';
            connectionIndicator.innerHTML = '‚ö™ –≤–Ω–µ –∫–æ–º–Ω–∞—Ç—ã';
            
            addLog(`üëã –≤—ã—à–ª–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã ${roomId}`, 'info');
            
        } catch (err) {
            addLog(`–æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ: ${err.message}`, 'error');
        }
    }

    // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
    joinBtn.addEventListener('click', async () => {
        const room = roomIdInput.value.trim();
        if (!room) { 
            addLog('–≤–≤–µ–¥–∏—Ç–µ id –∫–æ–º–Ω–∞—Ç—ã', 'error'); 
            return; 
        }
        if (currentRoom) {
            addLog('—Å–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∏–Ω—å—Ç–µ —Ç–µ–∫—É—â—É—é –∫–æ–º–Ω–∞—Ç—É', 'error');
            return;
        }
        await joinRoom(room);
    });

    leaveBtn.addEventListener('click', async () => {
        await leaveRoom();
    });

    // –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, –ø–æ—á–∏—Å—Ç–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
    window.addEventListener('beforeunload', () => {
        if (currentRoom) {
            database.ref(`rooms/${currentRoom}/members/${myUserId}`).remove();
        }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
    addLog(`–≤–∞—à ID: ${myUserId} ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è`, 'info');
    checkWebRTCSupport();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Firebase —Ä–∞–±–æ—Ç–∞–µ—Ç
    database.ref('.info/connected').on('value', (snap) => {
        if (snap.val() === true) {
            addLog('‚úÖ Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω', 'success');
        } else {
            addLog('‚ö†Ô∏è Firebase –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω', 'warning');
        }
    });
</script>
</body>
</html>