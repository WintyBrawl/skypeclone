<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skype ¬∑ –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç</title>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <!-- SimplePeer -->
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
    <style>
        /* Metro/Modern UI —Å—Ç–∏–ª—å –∫–∞–∫ –≤ Windows 8.1 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Segoe UI WP', 'Segoe UI Symbol', 'Helvetica Neue', sans-serif;
            background: #1b1f24;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            position: relative;
        }

        /* –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑–∞ –ª–æ–≥–æ–≤ */
        .log-toggle-btn {
            position: fixed;
            left: 20px;
            bottom: 20px;
            width: 48px;
            height: 48px;
            background: #2d2d2d;
            border: 2px solid #404040;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .log-toggle-btn:hover {
            background: #3d3d3d;
        }

        .log-toggle-btn.active {
            background: #00aff0;
            border-color: #008fc0;
        }

        /* –ü–∞–Ω–µ–ª—å –ª–æ–≥–æ–≤ */
        .log-panel {
            position: fixed;
            left: 20px;
            bottom: 78px;
            width: 500px;
            max-width: calc(100vw - 40px);
            background: #1b1f24;
            border: 2px solid #333333;
            color: #e0e0e0;
            font-family: 'Segoe UI', monospace;
            font-size: 13px;
            z-index: 999;
            display: none;
        }

        .log-panel.visible {
            display: block;
        }

        .log-header {
            background: #2d2d2d;
            padding: 10px 15px;
            border-bottom: 2px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-header span {
            color: white;
            font-weight: 300;
            text-transform: uppercase;
            font-size: 14px;
        }

        .log-close {
            background: none;
            border: 2px solid #555555;
            color: white;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .log-content {
            height: 250px;
            overflow-y: auto;
            padding: 10px;
        }

        .log-line {
            padding: 4px 0;
            border-bottom: 1px solid #333333;
            color: #cccccc;
            font-family: 'Segoe UI', monospace;
            font-size: 12px;
            word-break: break-word;
        }

        .log-line.error { color: #ff8a8a; }
        .log-line.success { color: #90e090; }
        .log-line.warning { color: #ffd966; }

        .log-controls {
            display: flex;
            gap: 2px;
            padding: 10px;
            background: #2d2d2d;
            border-top: 2px solid #404040;
        }

        .log-btn {
            background: #3a3a3a;
            border: 2px solid #4a4a4a;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            font-size: 12px;
            font-weight: 300;
            padding: 8px;
            cursor: pointer;
            flex: 1;
            text-align: center;
            text-transform: uppercase;
        }

        .metro-container {
            width: 1100px;
            max-width: 100%;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            box-shadow: none;
            border: none;
            margin: 0 auto;
        }

        /* –°–∏–Ω—è—è –ø–æ–ª–æ—Å–∫–∞ Skype */
        .metro-header {
            background: #00aff0;
            min-height: 60px;
            display: flex;
            align-items: center;
            padding: 10px 20px;
            color: white;
            font-size: 24px;
            font-weight: 300;
            flex-wrap: wrap;
            gap: 10px;
        }

        .metro-header span {
            font-weight: 300;
            text-transform: lowercase;
        }

        .metro-header .header-status {
            margin-left: auto;
            font-size: 14px;
            font-weight: 300;
            opacity: 0.9;
            white-space: nowrap;
        }

        .metro-grid {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            min-height: 600px;
        }

        .metro-tile-profile {
            width: 320px;
            max-width: 100%;
            background: #f0f0f0;
            border-right: 2px solid #d0d0d0;
            padding: 0;
        }

        .metro-tile-logs {
            flex: 1;
            min-width: 300px;
            background: #ffffff;
            display: flex;
            flex-direction: column;
        }

        .tile {
            background: #00aff0;
            color: white;
            padding: 20px 15px;
            margin: 0;
            border-bottom: 2px solid #008fc0;
        }

        .tile-title {
            font-size: 14px;
            font-weight: 300;
            text-transform: uppercase;
            opacity: 0.8;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .tile-content {
            font-size: 22px;
            font-weight: 300;
            word-break: break-all;
            font-family: 'Segoe UI', monospace;
        }

        .tile-content-small {
            font-size: 14px;
            font-weight: 300;
            opacity: 0.9;
        }

        .tile-room {
            background: #2d2d2d;
            color: white;
            padding: 20px 15px;
            border-bottom: 2px solid #404040;
        }

        .metro-input {
            background: #3a3a3a;
            border: 2px solid #555555;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            font-size: 16px;
            padding: 12px;
            width: 100%;
            margin: 8px 0;
            outline: none;
            font-weight: 300;
            -webkit-appearance: none;
            border-radius: 0;
        }

        .metro-input:focus {
            border-color: #00aff0;
            background: #454545;
        }

        .metro-btn {
            background: #00aff0;
            border: 2px solid #008fc0;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            font-size: 16px;
            font-weight: 300;
            padding: 12px 15px;
            margin: 4px 0;
            width: 100%;
            cursor: pointer;
            text-align: left;
            transition: background 0.1s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            -webkit-appearance: none;
            border-radius: 0;
        }

        .metro-btn:hover {
            background: #1fc2ff;
        }

        .metro-btn:active {
            background: #008fc0;
        }

        .metro-btn-green {
            background: #00b050;
            border-color: #009040;
        }

        .metro-btn-red {
            background: #e81123;
            border-color: #c01120;
        }

        .tile-members {
            background: #f0f0f0;
            color: #1b1f24;
            padding: 20px 15px;
            border-bottom: 2px solid #d0d0d0;
        }

        .members-list {
            display: flex;
            flex-wrap: wrap;
            margin-top: 10px;
            gap: 6px;
            min-height: 50px;
        }

        .member-badge-metro {
            background: #00aff0;
            color: white;
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 300;
            border: 2px solid #008fc0;
            display: inline-block;
            word-break: break-word;
        }

        .status-bar-metro {
            background: #1b1f24;
            color: white;
            padding: 12px 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            border-bottom: 2px solid #333333;
            font-weight: 300;
        }

        .status-item {
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: #f1c40f;
            margin-right: 8px;
            border: none;
            flex-shrink: 0;
        }

        .status-dot.green { background: #00b050; }
        .status-dot.red { background: #e81123; }
        .status-dot.yellow { background: #f1c40f; }
        .status-dot.gray { background: #7e7e7e; }

        .right-content {
            flex: 1;
            background: #f5f5f5;
            min-height: 200px;
            padding: 20px;
        }

        .audio-players {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .audio-player-item {
            background: #2d2d2d;
            border: 2px solid #404040;
            padding: 10px;
            color: white;
        }

        .audio-player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-weight: 300;
        }

        .audio-player-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .audio-play-btn {
            background: #00b050;
            border: 2px solid #009040;
            color: white;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 300;
            text-transform: uppercase;
            font-size: 12px;
        }

        .audio-play-btn:hover {
            background: #20c070;
        }

        .audio-volume {
            width: 100%;
            height: 4px;
            background: #404040;
            margin-top: 8px;
        }

        .audio-volume-fill {
            height: 100%;
            background: #00aff0;
            width: 0%;
            transition: width 0.1s;
        }

        .mic-warning {
            background: #f8d7da;
            border: 2px solid #721c24;
            color: #721c24;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            font-weight: 300;
            display: none;
        }

        .connection-status-text {
            font-weight: bold;
            margin-left: 5px;
        }

        .connection-status-text.connected { color: #00b050; }
        .connection-status-text.checking { color: #f1c40f; }
        .connection-status-text.failed { color: #e81123; }

        .speaking-indicator {
            width: 10px;
            height: 10px;
            background: #00b050;
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0.3; transform: scale(0.8); }
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
                align-items: flex-start;
            }

            .metro-grid {
                flex-direction: column;
            }

            .metro-tile-profile {
                width: 100%;
                border-right: none;
                border-bottom: 2px solid #d0d0d0;
            }

            .metro-tile-logs {
                width: 100%;
            }

            .metro-header {
                font-size: 20px;
                padding: 10px 15px;
            }

            .metro-header .header-status {
                font-size: 12px;
                white-space: normal;
            }

            .tile-content {
                font-size: 18px;
            }

            .status-bar-metro {
                gap: 10px;
            }

            .status-item {
                font-size: 12px;
            }

            .log-toggle-btn {
                left: 10px;
                bottom: 10px;
                width: 44px;
                height: 44px;
                font-size: 18px;
            }

            .log-panel {
                left: 10px;
                bottom: 64px;
                max-width: calc(100vw - 20px);
            }

            .log-content {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <button class="log-toggle-btn" id="logToggleBtn" title="–ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏">üìã</button>

    <div class="log-panel" id="logPanel">
        <div class="log-header">
            <span>—Å–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏</span>
            <button class="log-close" id="logCloseBtn">‚úï</button>
        </div>
        <div class="log-content" id="logContent">
            <div class="log-line">[system] –∑–∞–ø—É—Å–∫...</div>
        </div>
        <div class="log-controls">
            <button class="log-btn" id="copyLogsBtn">–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="log-btn" id="clearLogsBtn">–æ—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
    </div>

    <div class="metro-container">
        <div class="metro-header">
            <span>skype</span>
            <div class="header-status" id="fbStatusText">–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
        </div>

        <div class="metro-grid">
            <div class="metro-tile-profile">
                <div class="tile">
                    <div class="tile-title">–º–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä</div>
                    <div class="tile-content" id="myUserId">–∑–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div class="tile-content-small" style="margin-top: 8px;">–ø–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–∏–º id</div>
                </div>

                <div class="tile-room">
                    <div class="tile-title">–∫–æ–º–Ω–∞—Ç–∞</div>
                    <input type="text" id="roomInput" class="metro-input" placeholder="id –∫–æ–º–Ω–∞—Ç—ã" value="testroom">
                    
                    <button class="metro-btn metro-btn-green" id="joinBtn">–≤–æ–π—Ç–∏</button>
                    <button class="metro-btn metro-btn-red" id="leaveBtn">–ø–æ–∫–∏–Ω—É—Ç—å</button>
                    <button class="metro-btn" id="testMicBtn">—Ç–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</button>
                    
                    <div class="mic-warning" id="micWarning">
                        ‚ö†Ô∏è –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ –≤—ã –º–æ–∂–µ—Ç–µ —Å–ª—ã—à–∞—Ç—å –¥—Ä—É–≥–∏—Ö
                    </div>
                </div>

                <div class="tile-members">
                    <div class="tile-title">—É—á–∞—Å—Ç–Ω–∏–∫–∏ (<span id="memberCount">0</span>/4)</div>
                    <div id="membersList" class="members-list"></div>
                    <div style="margin-top: 15px; font-weight: 300;">
                        <span class="metro-text-small">—Ç–µ–∫—É—â–∞—è: </span>
                        <span id="currentRoom" style="font-weight: 300;">‚Äî</span>
                    </div>
                </div>
            </div>

            <div class="metro-tile-logs">
                <div class="status-bar-metro">
                    <div class="status-item">
                        <div class="status-dot" id="fbStatus"></div>
                        <span>firebase</span>
                    </div>
                    <div class="status-item">
                        <div class="status-dot" id="micStatus"></div>
                        <span>–º–∏–∫—Ä–æ—Ñ–æ–Ω</span>
                    </div>
                    <div class="status-item">
                        <div class="status-dot" id="peerStatus"></div>
                        <span>–ø–∏—Ä—ã: <span id="peerCount">0</span></span>
                    </div>
                </div>
                
                <div class="right-content">
                    <div style="font-weight: 300; margin-bottom: 15px; color: #1b1f24;">–≤—Ö–æ–¥—è—â–∏–π –∑–≤—É–∫:</div>
                    <div id="audioPlayersContainer" class="audio-players"></div>
                    <div id="noAudioMsg" style="font-weight: 300; color: #666; text-align: center; margin-top: 20px;">–Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫–æ–≤</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== FIREBASE ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDTx2Y9ctiWp26YeMmAHAxDZd_gVI_ZMdw",
            authDomain: "kcalls.firebaseapp.com",
            databaseURL: "https://kcalls-default-rtdb.firebaseio.com",
            projectId: "kcalls",
            storageBucket: "kcalls.firebasestorage.app",
            messagingSenderId: "990117089104",
            appId: "1:990117089104:web:278a42c037e975ebb76655"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ==================== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        const myUserId = 'user_' + Math.random().toString(36).substring(2, 8);
        document.getElementById('myUserId').innerText = myUserId;

        let localStream = null;
        let peers = {};
        let currentRoom = null;
        let roomRef = null;
        let callsRef = null;
        let allUsers = {};
        let audioElements = {};
        let reconnectTimeouts = {};
        let pendingSignals = {};
        let analyserIntervals = {};
        let audioUnlocked = false;
        let micAvailable = false;
        let isInRoom = false;

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const logPanel = document.getElementById('logPanel');
        const logContent = document.getElementById('logContent');
        const logToggleBtn = document.getElementById('logToggleBtn');
        const logCloseBtn = document.getElementById('logCloseBtn');
        const membersList = document.getElementById('membersList');
        const currentRoomSpan = document.getElementById('currentRoom');
        const roomInput = document.getElementById('roomInput');
        const joinBtn = document.getElementById('joinBtn');
        const leaveBtn = document.getElementById('leaveBtn');
        const testMicBtn = document.getElementById('testMicBtn');
        const copyLogsBtn = document.getElementById('copyLogsBtn');
        const clearLogsBtn = document.getElementById('clearLogsBtn');
        const memberCount = document.getElementById('memberCount');
        const peerCount = document.getElementById('peerCount');
        const audioPlayersContainer = document.getElementById('audioPlayersContainer');
        const noAudioMsg = document.getElementById('noAudioMsg');
        const micWarning = document.getElementById('micWarning');
        
        const fbStatus = document.getElementById('fbStatus');
        const fbStatusText = document.getElementById('fbStatusText');
        const micStatus = document.getElementById('micStatus');
        const peerStatus = document.getElementById('peerStatus');

        // ==================== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ====================
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const line = document.createElement('div');
            line.className = 'log-line';
            if (type === 'error') line.classList.add('error');
            if (type === 'success') line.classList.add('success');
            if (type === 'warning') line.classList.add('warning');
            
            let prefix = '';
            if (type === 'error') prefix = 'ERROR: ';
            else if (type === 'success') prefix = 'OK: ';
            else if (type === 'warning') prefix = 'WARNING: ';
            
            line.innerHTML = `[${time}] ${prefix}${message}`;
            logContent.appendChild(line);
            logContent.scrollTop = logContent.scrollHeight;
            
            if (type === 'error') console.error(message);
            else console.log(message);
        }

        clearLogsBtn.addEventListener('click', () => {
            logContent.innerHTML = '<div class="log-line">[system] –ª–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã</div>';
        });

        copyLogsBtn.addEventListener('click', () => {
            let text = '';
            document.querySelectorAll('#logContent .log-line').forEach(div => {
                text += div.innerText + '\n';
            });
            navigator.clipboard.writeText(text).then(() => {
                log('–ª–æ–≥–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã', 'success');
            });
        });

        logToggleBtn.addEventListener('click', () => {
            logPanel.classList.toggle('visible');
            logToggleBtn.classList.toggle('active');
        });

        logCloseBtn.addEventListener('click', () => {
            logPanel.classList.remove('visible');
            logToggleBtn.classList.remove('active');
        });

        // ==================== –ê–£–î–ò–û ====================
        function unlockAudio() {
            if (audioUnlocked) return;
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            audioContext.resume().then(() => {
                log('üîä –∞—É–¥–∏–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ', 'success');
                audioUnlocked = true;
                
                Object.values(audioElements).forEach(audio => {
                    if (audio.srcObject) {
                        audio.play().catch(e => log(`–æ—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: ${e.message}`, 'error'));
                    }
                });
            });
        }

        document.addEventListener('click', function once() {
            unlockAudio();
            document.removeEventListener('click', once);
        }, { once: true });

        async function initMic(force = false) {
            if (localStream && !force) {
                micAvailable = true;
                micStatus.className = 'status-dot green';
                micWarning.style.display = 'none';
                return localStream;
            }
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                micAvailable = false;
                micStatus.className = 'status-dot gray';
                micWarning.style.display = 'block';
                log('getUserMedia –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (–±—É–¥–µ—Ç–µ —Ç–æ–ª—å–∫–æ —Å–ª—É—à–∞—Ç—å)', 'warning');
                return null;
            }
            
            try {
                micStatus.className = 'status-dot yellow';
                log('–∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω...');
                
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                micAvailable = true;
                micStatus.className = 'status-dot green';
                micWarning.style.display = 'none';
                log('–º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–ª—É—á–µ–Ω', 'success');
                
                localStream.getTracks().forEach(track => {
                    log(`—Ç—Ä–µ–∫ ${track.kind}: enabled=${track.enabled}`, 'info');
                });
                
                return localStream;
                
            } catch (err) {
                micAvailable = false;
                micStatus.className = 'status-dot gray';
                micWarning.style.display = 'block';
                
                let msg = '–º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω (–±—É–¥–µ—Ç–µ —Ç–æ–ª—å–∫–æ —Å–ª—É—à–∞—Ç—å): ';
                if (err.name === 'NotAllowedError') msg += '–¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω';
                else if (err.name === 'NotFoundError') msg += '–º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω';
                else msg += err.message;
                
                log(msg, 'warning');
                return null;
            }
        }

        testMicBtn.addEventListener('click', async () => {
            const stream = await initMic(true);
            if (stream) {
                log('—Ç–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ —É—Å–ø–µ—à–µ–Ω', 'success');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –∑–≤—É–∫–∞
                const audioContext = new AudioContext();
                const analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                
                analyser.fftSize = 256;
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                
                const interval = setInterval(() => {
                    analyser.getByteFrequencyData(dataArray);
                    const avg = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    if (avg > 10) {
                        log(`—É—Ä–æ–≤–µ–Ω—å –∑–≤—É–∫–∞: ${Math.round(avg)}`, 'info');
                    }
                }, 200);
                
                setTimeout(() => {
                    clearInterval(interval);
                    stream.getTracks().forEach(t => t.stop());
                }, 3000);
                
            } else {
                log('–º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω', 'warning');
            }
        });

        // ==================== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê ====================
        function updateAudioPlayers() {
            if (Object.keys(audioElements).length === 0) {
                audioPlayersContainer.innerHTML = '';
                noAudioMsg.style.display = 'block';
                return;
            }
            
            noAudioMsg.style.display = 'none';
            
            let html = '';
            for (let [userId, audio] of Object.entries(audioElements)) {
                const userName = allUsers[userId]?.name || userId;
                const hasAudio = audio.srcObject;
                const isSpeaking = analyserIntervals[userId] ? 'speaking-indicator' : '';
                
                html += `
                    <div class="audio-player-item" id="player_${userId}">
                        <div class="audio-player-header">
                            <span>${userName} <span class="${isSpeaking}"></span></span>
                            <div class="audio-player-controls">
                                <button class="audio-play-btn" onclick="playAudio('${userId}')">‚ñ∂ –≤–∫–ª—é—á–∏—Ç—å</button>
                            </div>
                        </div>
                        <div class="audio-volume" id="volume_${userId}">
                            <div class="audio-volume-fill" id="volumeFill_${userId}"></div>
                        </div>
                    </div>
                `;
            }
            
            audioPlayersContainer.innerHTML = html;
        }

        function playAudio(userId) {
            const audio = audioElements[userId];
            if (audio && audio.srcObject) {
                audio.play().catch(e => log(`–æ—à–∏–±–∫–∞: ${e.message}`, 'error'));
            }
        }

        function updateMembersList() {
            const userIds = Object.keys(allUsers);
            memberCount.innerText = userIds.length;
            
            membersList.innerHTML = '';
            userIds.forEach(uid => {
                const span = document.createElement('span');
                span.className = 'member-badge-metro';
                span.innerText = (allUsers[uid]?.name || uid) + (uid === myUserId ? ' (—è)' : '');
                membersList.appendChild(span);
            });
        }

        function updatePeerStats() {
            let connected = 0;
            let total = Object.keys(peers).length;
            
            for (let id in peers) {
                if (peers[id] && peers[id].connected) {
                    connected++;
                }
            }
            
            peerCount.innerText = `${total} (${connected} —Å–æ–µ–¥.)`;
            
            if (connected > 0) {
                peerStatus.className = 'status-dot green';
            } else if (total > 0) {
                peerStatus.className = 'status-dot yellow';
            } else {
                peerStatus.className = 'status-dot gray';
            }
        }

        // ==================== ICE –°–ï–†–í–ï–†–´ ====================
        function getIceServers() {
            return [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' },
                {
                    urls: [
                        'turn:openrelay.metered.ca:80',
                        'turn:openrelay.metered.ca:443'
                    ],
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                }
            ];
        }

        // ==================== –°–û–ó–î–ê–ù–ò–ï PEER ====================
        function createPeerWith(userId, userName) {
            if (peers[userId] && !peers[userId].destroyed) {
                log(`–ø–∏—Ä —Å ${userName} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`, 'info');
                return;
            }
            
            log(`—Å–æ–∑–¥–∞—é –ø–∏—Ä —Å ${userName}`, 'info');
            
            const isInit = myUserId < userId;
            
            try {
                const peer = new SimplePeer({ 
                    initiator: isInit, 
                    stream: localStream,
                    trickle: true,
                    config: { iceServers: getIceServers() }
                });
                
                peer.userName = userName;
                
                // –°–æ–∑–¥–∞–µ–º –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç
                const audioEl = document.createElement('audio');
                audioEl.id = `audio-${userId}`;
                audioEl.autoplay = true;
                audioEl.style.display = 'none';
                document.body.appendChild(audioEl);
                audioElements[userId] = audioEl;

                peer.on('signal', data => {
                    log(`üì§ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–∏–≥–Ω–∞–ª–∞ –¥–ª—è ${userName}`, 'info');
                    db.ref('calls/' + currentRoom).push({
                        from: myUserId,
                        to: userId,
                        data: data
                    });
                });

                peer.on('stream', stream => {
                    log(`üì• –ø–æ–ª—É—á–µ–Ω –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫ –æ—Ç ${userName}`, 'success');
                    
                    if (audioElements[userId]) {
                        audioElements[userId].srcObject = stream;
                        
                        if (audioUnlocked) {
                            audioElements[userId].play().catch(e => log(`–æ—à–∏–±–∫–∞: ${e.message}`, 'error'));
                        }
                    }
                    
                    updateAudioPlayers();
                    
                    // –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –≥—Ä–æ–º–∫–æ—Å—Ç–∏
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const analyser = audioContext.createAnalyser();
                        const source = audioContext.createMediaStreamSource(stream);
                        source.connect(analyser);
                        
                        analyser.fftSize = 256;
                        const dataArray = new Uint8Array(analyser.frequencyBinCount);
                        
                        analyserIntervals[userId] = setInterval(() => {
                            analyser.getByteFrequencyData(dataArray);
                            const avg = dataArray.reduce((a, b) => a + b) / dataArray.length;
                            
                            const volumeEl = document.getElementById(`volumeFill_${userId}`);
                            if (volumeEl) {
                                const percent = Math.min(100, (avg / 128) * 100);
                                volumeEl.style.width = percent + '%';
                            }
                        }, 100);
                    } catch (e) {
                        log(`–æ—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞: ${e.message}`, 'error');
                    }
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã
                    if (pendingSignals[userId]) {
                        log(`üì¶ –ø—Ä–∏–º–µ–Ω—è—é ${pendingSignals[userId].length} –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤`, 'info');
                        pendingSignals[userId].forEach(signalData => {
                            try {
                                peer.signal(signalData);
                            } catch (e) {
                                log(`–æ—à–∏–±–∫–∞ —Å–∏–≥–Ω–∞–ª–∞: ${e.message}`, 'error');
                            }
                        });
                        delete pendingSignals[userId];
                    }
                });

                peer.on('connect', () => {
                    log(`‚úÖ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${userName} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ`, 'success');
                    updatePeerStats();
                    
                    if (reconnectTimeouts[userId]) {
                        clearTimeout(reconnectTimeouts[userId]);
                        delete reconnectTimeouts[userId];
                    }
                });

                peer.on('error', (err) => {
                    log(`‚ùå –æ—à–∏–±–∫–∞ –ø–∏—Ä–∞ —Å ${userName}: ${err.message}`, 'error');
                    
                    if (!reconnectTimeouts[userId] && allUsers[userId]) {
                        reconnectTimeouts[userId] = setTimeout(() => {
                            log(`üîÑ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ${userName}...`, 'warning');
                            if (peers[userId] && !peers[userId].destroyed) {
                                peers[userId].destroy();
                            }
                            delete peers[userId];
                            createPeerWith(userId, userName);
                            delete reconnectTimeouts[userId];
                        }, 3000);
                    }
                });

                peer.on('close', () => {
                    log(`üîí –ø–∏—Ä —Å ${userName} –∑–∞–∫—Ä—ã—Ç`, 'info');
                    
                    if (audioElements[userId]) {
                        audioElements[userId].remove();
                        delete audioElements[userId];
                    }
                    
                    if (analyserIntervals[userId]) {
                        clearInterval(analyserIntervals[userId]);
                        delete analyserIntervals[userId];
                    }
                    
                    updateAudioPlayers();
                    updatePeerStats();
                });

                peers[userId] = peer;
                updatePeerStats();
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
                if (pendingSignals[userId]) {
                    setTimeout(() => {
                        if (peers[userId] && !peers[userId].destroyed) {
                            pendingSignals[userId].forEach(signalData => {
                                try {
                                    peers[userId].signal(signalData);
                                } catch (e) {
                                    log(`–æ—à–∏–±–∫–∞ —Å–∏–≥–Ω–∞–ª–∞: ${e.message}`, 'error');
                                }
                            });
                            delete pendingSignals[userId];
                        }
                    }, 1000);
                }

            } catch (err) {
                log(`‚ùå –æ—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∏—Ä–∞: ${err.message}`, 'error');
            }
        }

        // ==================== –í–•–û–î –í –ö–û–ú–ù–ê–¢–£ ====================
        async function joinRoom() {
            const roomId = roomInput.value.trim();
            if (!roomId) { log('–≤–≤–µ–¥–∏—Ç–µ id –∫–æ–º–Ω–∞—Ç—ã', 'error'); return; }
            
            if (currentRoom) {
                await leaveRoom();
            }

            await initMic().catch(() => {});

            currentRoom = roomId;
            isInRoom = true;
            currentRoomSpan.innerText = roomId;
            log(`–≤—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É: ${roomId}`, 'info');

            roomRef = db.ref('rooms/' + roomId);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è
            await roomRef.child('users/' + myUserId).set({ 
                name: myUserId,
                timestamp: Date.now()
            });
            roomRef.child('users/' + myUserId).onDisconnect().remove();

            // –°–ª—É—à–∞–µ–º calls
            callsRef = db.ref('calls/' + roomId);
            callsRef.on('child_added', (snap) => {
                const signal = snap.val();
                if (signal.from !== myUserId) {
                    log(`üì® —Å–∏–≥–Ω–∞–ª –æ—Ç ${signal.from}`, 'info');
                    
                    if (peers[signal.from] && !peers[signal.from].destroyed) {
                        try {
                            peers[signal.from].signal(signal.data);
                        } catch (e) {
                            log(`–æ—à–∏–±–∫–∞ —Å–∏–≥–Ω–∞–ª–∞: ${e.message}`, 'error');
                        }
                    } else {
                        if (!pendingSignals[signal.from]) pendingSignals[signal.from] = [];
                        pendingSignals[signal.from].push(signal.data);
                    }
                    snap.ref.remove();
                }
            });

            // –°–ª—É—à–∞–µ–º users
            roomRef.child('users').on('value', (snap) => {
                const users = snap.val() || {};
                
                // –ù–∞—Ö–æ–¥–∏–º –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                Object.keys(users).forEach(userId => {
                    if (userId !== myUserId && !allUsers[userId]) {
                        log(`üîî –Ω–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫: ${userId}`, 'info');
                    }
                });
                
                // –ù–∞—Ö–æ–¥–∏–º –≤—ã—à–µ–¥—à–∏—Ö
                Object.keys(allUsers).forEach(userId => {
                    if (userId !== myUserId && !users[userId]) {
                        log(`üîî —É—á–∞—Å—Ç–Ω–∏–∫ –≤—ã—à–µ–ª: ${userId}`, 'info');
                    }
                });
                
                allUsers = users;
                
                // –°–æ–∑–¥–∞–µ–º –ø–∏—Ä—ã –¥–ª—è –Ω–æ–≤—ã—Ö
                Object.keys(users).forEach(userId => {
                    if (userId !== myUserId && !peers[userId]) {
                        createPeerWith(userId, userId);
                    }
                });
                
                // –£–¥–∞–ª—è–µ–º –ø–∏—Ä—ã –≤—ã—à–µ–¥—à–∏—Ö
                Object.keys(peers).forEach(userId => {
                    if (!users[userId]) {
                        if (peers[userId] && !peers[userId].destroyed) {
                            peers[userId].destroy();
                        }
                        delete peers[userId];
                        
                        if (audioElements[userId]) {
                            audioElements[userId].remove();
                            delete audioElements[userId];
                        }
                        
                        if (analyserIntervals[userId]) {
                            clearInterval(analyserIntervals[userId]);
                            delete analyserIntervals[userId];
                        }
                    }
                });
                
                updateMembersList();
                updateAudioPlayers();
                updatePeerStats();
            });

            log('—É—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç—É', 'success');
        }

        // ==================== –í–´–•–û–î –ò–ó –ö–û–ú–ù–ê–¢–´ ====================
        async function leaveRoom() {
            if (!currentRoom) {
                log('–≤—ã –Ω–µ –≤ –∫–æ–º–Ω–∞—Ç–µ', 'warning');
                return;
            }

            const roomId = currentRoom;
            isInRoom = false;
            
            try {
                if (roomRef) {
                    await roomRef.child('users/' + myUserId).remove();
                    roomRef.child('users').off();
                    roomRef = null;
                }
                
                if (callsRef) {
                    callsRef.off();
                    callsRef = null;
                }
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–∏—Ä—ã
                Object.values(reconnectTimeouts).forEach(timeout => clearTimeout(timeout));
                reconnectTimeouts = {};
                
                Object.values(analyserIntervals).forEach(interval => clearInterval(interval));
                analyserIntervals = {};
                
                Object.values(peers).forEach(peer => {
                    if (peer && !peer.destroyed) peer.destroy();
                });
                peers = {};
                
                Object.values(audioElements).forEach(audio => audio.remove());
                audioElements = {};
                
                pendingSignals = {};
                allUsers = {};
                
                currentRoom = null;
                currentRoomSpan.innerText = '‚Äî';
                membersList.innerHTML = '';
                memberCount.innerText = '0';
                
                updateAudioPlayers();
                updatePeerStats();
                
                log('–≤—ã—à–ª–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã', 'success');
                
            } catch (err) {
                log(`–æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ: ${err.message}`, 'error');
            }
        }

        // ==================== FIREBASE –°–¢–ê–¢–£–° ====================
        db.ref('.info/connected').on('value', (snap) => {
            if (snap.val()) {
                fbStatus.className = 'status-dot green';
                fbStatusText.innerText = '–ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
                log('firebase –ø–æ–¥–∫–ª—é—á–µ–Ω', 'success');
            } else {
                fbStatus.className = 'status-dot red';
                fbStatusText.innerText = '–æ—Ç–∫–ª—é—á–µ–Ω–æ';
                log('firebase –æ—Ç–∫–ª—é—á–µ–Ω', 'error');
            }
        });

        // ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ====================
        joinBtn.addEventListener('click', joinRoom);
        leaveBtn.addEventListener('click', leaveRoom);

        window.addEventListener('beforeunload', () => {
            if (currentRoom) {
                db.ref('rooms/' + currentRoom + '/users/' + myUserId).remove();
            }
        });

        // ==================== –°–¢–ê–†–¢ ====================
        log(`–≤–∞—à id: ${myUserId}`, 'info');
    </script>
</body>
</html>