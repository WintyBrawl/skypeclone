<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç ¬∑ 4 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ¬∑ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <!-- Firebase SDK (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background: #2b3e4f;
            font-family: 'Segoe UI', system-ui, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 12px;
        }
        .chat-container {
            width: 1000px;
            max-width: 100%;
            background: #d9e2ec;
            border: 2px solid #0a3147;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 12px 28px rgba(0,0,0,0.5);
        }
        .header {
            background: #1a4359;
            color: #eaf1f8;
            padding: 16px 20px;
            font-size: 20px;
            font-weight: 600;
            letter-spacing: 0.3px;
            border-bottom: 2px solid #0b2637;
        }
        .main-panels {
            display: flex;
            flex-wrap: wrap;
        }
        .left-panel {
            width: 290px;
            background: #c8d9eb;
            padding: 20px 16px;
            border-right: 2px solid #809bb3;
        }
        .right-panel {
            flex: 1;
            background: #e2ecf7;
            padding: 20px;
            min-width: 280px;
        }
        .info-card {
            background: #b4cef0;
            border: 2px solid #36648b;
            border-radius: 24px;
            padding: 20px 12px;
            text-align: center;
            margin-bottom: 28px;
        }
        .user-id-label {
            font-size: 15px;
            color: #123e5c;
            margin-bottom: 6px;
        }
        .user-id-value {
            background: #ffffff;
            border: 2px solid #1e537b;
            border-radius: 40px;
            padding: 12px 8px;
            font-family: monospace;
            font-size: 20px;
            font-weight: bold;
            color: #02233b;
            word-break: break-all;
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #0a344f;
            margin: 20px 0 12px 0;
            border-bottom: 2px solid #587a9f;
            padding-bottom: 5px;
        }
        .input-field {
            padding: 14px 16px;
            font-size: 16px;
            border: 2px solid #2e6291;
            border-radius: 50px;
            background: white;
            outline: none;
            width: 100%;
            margin-bottom: 12px;
        }
        .btn {
            background: #eef6ff;
            border: 2px solid #1e5b8e;
            border-radius: 40px;
            padding: 14px 20px;
            font-weight: 600;
            font-size: 16px;
            color: #0f334d;
            cursor: pointer;
            box-shadow: 3px 3px 0 #1b3f61;
            transition: 0.03s linear;
            width: 100%;
            margin-bottom: 8px;
        }
        .btn:active {
            transform: translate(3px, 3px);
            box-shadow: none;
        }
        .btn-join {
            background: #b9e0b9;
            border-color: #1e6b1e;
            color: #003000;
        }
        .btn-leave {
            background: #f3c2c2;
            border-color: #a13d3d;
            color: #420000;
        }
        .room-panel {
            background: #d5e5fa;
            border: 2px solid #3b6c9c;
            border-radius: 30px;
            padding: 18px;
            margin: 16px 0;
            text-align: center;
        }
        .log-container {
            background: #102331;
            color: #b4e0ff;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            padding: 18px;
            border-radius: 16px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 2px solid #4280b0;
            margin: 20px 0;
        }
        .log-line {
            border-bottom: 1px solid #2f5577;
            padding: 4px 0;
            font-family: monospace;
        }
        .log-line.info { color: #c5e2ff; }
        .log-line.success { color: #a3d8a3; }
        .log-line.warning { color: #ffd966; }
        .log-line.error { color: #ffaeae; }
        
        .user-badge {
            display: inline-block;
            background: #316e9e;
            color: white;
            border-radius: 40px;
            padding: 6px 14px;
            margin: 4px 6px 4px 0;
            font-size: 14px;
            border: 1px solid #6ea5d4;
        }
        .status-badge {
            background: #4f6b85;
            color: white;
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 14px;
        }
        .member-list {
            margin: 18px 0;
            min-height: 70px;
        }
        .debug-panel {
            background: #1e3a5a;
            color: white;
            padding: 12px;
            border-radius: 16px;
            margin: 10px 0;
            font-size: 13px;
        }
        .connection-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
        }
        .status-green { background: #2ecc71; }
        .status-yellow { background: #f1c40f; }
        .status-red { background: #e74c3c; }
    </style>
</head>
<body>
<div class="chat-container">
    <div class="header">
        üé§ –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç ¬∑ mesh (–¥–æ 4) ¬∑ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
    </div>
    <div class="main-panels">
        <!-- –ª–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="left-panel">
            <div class="info-card">
                <div class="user-id-label">–º–æ–π ID</div>
                <div class="user-id-value" id="myUserIdDisplay">–∑–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>

            <div class="section-title">–∫–æ–º–Ω–∞—Ç–∞</div>
            <input type="text" id="roomIdInput" class="input-field" placeholder="id –∫–æ–º–Ω–∞—Ç—ã" value="testroom">
            
            <button class="btn btn-join" id="joinRoomBtn">‚ûï –≤–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
            <button class="btn btn-leave" id="leaveRoomBtn">‚úñ –ø–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
            <button class="btn" id="testMicBtn">üé§ —Ç–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</button>

            <div class="room-panel">
                <div style="font-weight:600; margin-bottom:10px;">—É—á–∞—Å—Ç–Ω–∏–∫–∏ (<span id="memberCount">0</span>/4)</div>
                <div id="membersContainer" class="member-list">
                    <span class="status-badge">–Ω–µ—Ç –≤ –∫–æ–º–Ω–∞—Ç–µ</span>
                </div>
                <div style="font-size:13px;">—Ç–µ–∫—É—â–∞—è: <span id="currentRoomSpan">‚Äî</span></div>
            </div>

            <div class="debug-panel" id="statusPanel">
                <div><span class="connection-status status-yellow" id="fbStatus"></span> Firebase: <span id="fbStatusText">–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span></div>
                <div><span class="connection-status status-yellow" id="micStatus"></span> –º–∏–∫—Ä–æ—Ñ–æ–Ω: <span id="micStatusText">–Ω–µ –∑–∞–ø—Ä–æ—à–µ–Ω</span></div>
                <div><span class="connection-status status-yellow" id="peerStatus"></span> –ø–∏—Ä—ã: <span id="peerCount">0</span></div>
            </div>
        </div>

        <!-- –ø—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –ª–æ–≥–∞–º–∏ -->
        <div class="right-panel">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button class="btn" id="copyLogBtn" style="padding: 8px;">üìã –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏</button>
                <button class="btn" id="clearLogBtn" style="padding: 8px;">üóë –æ—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
            
            <div id="logPanel" class="log-container">
                <div class="log-line info">[system] –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
            </div>
            
            <div style="background: #adc5de; padding: 8px 12px; border-radius: 20px; font-size: 12px;">
                üîß –µ—Å–ª–∏ –∑–≤—É–∫–∞ –Ω–µ—Ç: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω —Ä–∞–∑—Ä–µ—à—ë–Ω, –∏ –≤—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –≤ –æ–¥–Ω–æ–π –∫–æ–º–Ω–∞—Ç–µ
            </div>
        </div>
    </div>
</div>

<script>
    // ------------------------------------------------------------
    // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    const firebaseConfig = {
        apiKey: "AIzaSyDTx2Y9ctiWp26YeMmAHAxDZd_gVI_ZMdw",
        authDomain: "kcalls.firebaseapp.com",
        databaseURL: "https://kcalls-default-rtdb.firebaseio.com",
        projectId: "kcalls",
        storageBucket: "kcalls.firebasestorage.app",
        messagingSenderId: "990117089104",
        appId: "1:990117089104:web:278a42c037e975ebb76655",
        measurementId: "G-TK6GVEX9G5"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // ------------------------------------------------------------
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    const myUserId = 'user_' + Math.random().toString(36).substring(2, 8);
    document.getElementById('myUserIdDisplay').innerText = myUserId;

    let localStream = null;
    let peerConnections = new Map(); // userId -> RTCPeerConnection
    let currentRoom = null;
    let roomMembers = new Set();
    
    // Firebase listeners
    let membersListener = null;
    let offersListener = null;
    let answersListener = null;
    let candidatesListener = null;

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const logPanel = document.getElementById('logPanel');
    const membersContainer = document.getElementById('membersContainer');
    const currentRoomSpan = document.getElementById('currentRoomSpan');
    const roomIdInput = document.getElementById('roomIdInput');
    const joinBtn = document.getElementById('joinRoomBtn');
    const leaveBtn = document.getElementById('leaveRoomBtn');
    const testMicBtn = document.getElementById('testMicBtn');
    const copyLogBtn = document.getElementById('copyLogBtn');
    const clearLogBtn = document.getElementById('clearLogBtn');
    const memberCount = document.getElementById('memberCount');
    const peerCount = document.getElementById('peerCount');
    
    // –°—Ç–∞—Ç—É—Å –ø–∞–Ω–µ–ª—å
    const fbStatus = document.getElementById('fbStatus');
    const fbStatusText = document.getElementById('fbStatusText');
    const micStatus = document.getElementById('micStatus');
    const micStatusText = document.getElementById('micStatusText');
    const peerStatus = document.getElementById('peerStatus');

    // ------------------------------------------------------------
    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    function addLog(message, type = 'info') {
        const time = new Date().toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        const line = document.createElement('div');
        line.className = `log-line ${type}`;
        
        let prefix = '‚û°Ô∏è';
        if (type === 'error') prefix = '‚ùå';
        else if (type === 'warning') prefix = '‚ö†Ô∏è';
        else if (type === 'success') prefix = '‚úÖ';
        
        line.innerHTML = `[${time}] ${prefix} ${message}`;
        logPanel.appendChild(line);
        logPanel.scrollTop = logPanel.scrollHeight;
        
        if (type === 'error') console.error(message);
        else console.log(message);
    }

    clearLogBtn.addEventListener('click', () => {
        logPanel.innerHTML = '<div class="log-line info">[system] –ª–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã</div>';
    });

    copyLogBtn.addEventListener('click', () => {
        let logText = '';
        document.querySelectorAll('.log-line').forEach(div => {
            logText += div.innerText + '\n';
        });
        navigator.clipboard.writeText(logText).then(() => {
            addLog('–ª–æ–≥–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã', 'success');
        });
    });

    // ------------------------------------------------------------
    // –ú–∏–∫—Ä–æ—Ñ–æ–Ω
    async function initMicrophone(force = false) {
        if (localStream && !force) {
            micStatus.className = 'connection-status status-green';
            micStatusText.innerText = '–¥–æ—Å—Ç—É–ø–µ–Ω';
            return localStream;
        }
        
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            micStatus.className = 'connection-status status-red';
            micStatusText.innerText = '–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
            addLog('getUserMedia –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (–Ω—É–∂–µ–Ω HTTPS)', 'error');
            throw new Error('getUserMedia not supported');
        }
        
        try {
            micStatus.className = 'connection-status status-yellow';
            micStatusText.innerText = '–∑–∞–ø—Ä–æ—Å...';
            addLog('–∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω...');
            
            localStream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            });
            
            micStatus.className = 'connection-status status-green';
            micStatusText.innerText = '–¥–æ—Å—Ç—É–ø–µ–Ω';
            addLog('–º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–ª—É—á–µ–Ω', 'success');
            
            localStream.getTracks().forEach(track => {
                addLog(`  —Ç—Ä–µ–∫ ${track.kind}: enabled=${track.enabled}`, 'info');
            });
            
            return localStream;
            
        } catch (err) {
            micStatus.className = 'connection-status status-red';
            micStatusText.innerText = '–æ—à–∏–±–∫–∞';
            
            let errorMsg = '–æ—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: ';
            if (err.name === 'NotAllowedError') errorMsg += '–¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω';
            else if (err.name === 'NotFoundError') errorMsg += '–º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω';
            else errorMsg += err.message;
            
            addLog(errorMsg, 'error');
            throw err;
        }
    }

    testMicBtn.addEventListener('click', async () => {
        try {
            await initMicrophone(true);
            addLog('—Ç–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ —É—Å–ø–µ—à–µ–Ω', 'success');
        } catch (err) {
            addLog('—Ç–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω', 'error');
        }
    });

    // ------------------------------------------------------------
    // –°–æ–∑–¥–∞–Ω–∏–µ peer connection
    async function createPeerConnection(targetUserId) {
        if (peerConnections.has(targetUserId)) {
            addLog(`–∑–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${targetUserId}`, 'warning');
            peerConnections.get(targetUserId).close();
            peerConnections.delete(targetUserId);
        }

        if (!localStream) {
            addLog('–Ω–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞, –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å', 'warning');
            try { await initMicrophone(); } catch (err) {}
        }

        const pc = new RTCPeerConnection({
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' }
            ]
        });

        // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–∫–∏
        if (localStream) {
            localStream.getTracks().forEach(track => {
                try {
                    pc.addTrack(track, localStream);
                    addLog(`–¥–æ–±–∞–≤–ª–µ–Ω —Ç—Ä–µ–∫ –¥–ª—è ${targetUserId}`, 'info');
                } catch (err) {
                    addLog(`–æ—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–∞: ${err.message}`, 'error');
                }
            });
        }

        // ICE candidates
        pc.onicecandidate = (e) => {
            if (e.candidate && currentRoom) {
                const candidatePath = `rooms/${currentRoom}/candidates/${myUserId}/${targetUserId}`;
                database.ref(candidatePath).push(e.candidate.toJSON())
                    .then(() => addLog(`ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–ª—è ${targetUserId} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω`, 'info'))
                    .catch(err => addLog(`–æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ICE: ${err.message}`, 'error'));
            }
        };

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∞—É–¥–∏–æ
        pc.ontrack = (e) => {
            addLog(`‚úÖ –ø–æ–ª—É—á–µ–Ω –∞—É–¥–∏–æ—Ç—Ä–µ–∫ –æ—Ç ${targetUserId}`, 'success');
            
            let audioEl = document.getElementById(`audio_${targetUserId}`);
            if (!audioEl) {
                audioEl = document.createElement('audio');
                audioEl.id = `audio_${targetUserId}`;
                audioEl.autoplay = true;
                audioEl.style.display = 'none';
                document.body.appendChild(audioEl);
            }
            
            try {
                audioEl.srcObject = e.streams[0];
                audioEl.play().catch(err => addLog(`–æ—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: ${err.message}`, 'warning'));
                addLog(`–∞—É–¥–∏–æ –æ—Ç ${targetUserId} –ø–æ–¥–∫–ª—é—á–µ–Ω–æ`, 'success');
            } catch (err) {
                addLog(`–æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∞—É–¥–∏–æ: ${err.message}`, 'error');
            }
        };

        // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        pc.oniceconnectionstatechange = () => {
            addLog(`[ICE ${targetUserId}] ${pc.iceConnectionState}`, 'info');
            updatePeerCount();
        };

        pc.onconnectionstatechange = () => {
            addLog(`[CONN ${targetUserId}] ${pc.connectionState}`, 'info');
            updatePeerCount();
        };

        peerConnections.set(targetUserId, pc);
        updatePeerCount();
        return pc;
    }

    // ------------------------------------------------------------
    // –ó–∞–∫—Ä—ã—Ç—å –≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    async function closeAllPeers() {
        for (let [userId, pc] of peerConnections) {
            try {
                pc.close();
                const audioEl = document.getElementById(`audio_${userId}`);
                if (audioEl) audioEl.remove();
            } catch (err) {
                addLog(`–æ—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–∏—Ä–∞ ${userId}: ${err.message}`, 'error');
            }
        }
        peerConnections.clear();
        updatePeerCount();
        addLog('–≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∑–∞–∫—Ä—ã—Ç—ã', 'info');
    }

    // ------------------------------------------------------------
    // –í—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É
    async function joinRoom(roomId) {
        if (!roomId) { addLog('–≤–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã', 'error'); return; }
        if (currentRoom) { addLog('—Å–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∏–Ω—å—Ç–µ —Ç–µ–∫—É—â—É—é –∫–æ–º–Ω–∞—Ç—É', 'error'); return; }

        await initMicrophone().catch(() => {});

        currentRoom = roomId;
        currentRoomSpan.innerText = roomId;
        addLog(`–≤—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É: ${roomId}`, 'info');

        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏ –µ—Å–ª–∏ –±—ã–ª–∏
        if (membersListener) membersListener.off();

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è
        const membersRef = database.ref(`rooms/${roomId}/members`);
        await membersRef.child(myUserId).set({
            joined: Date.now(),
            userAgent: navigator.userAgent.substring(0, 50)
        });

        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        membersListener = membersRef.on('value', (snap) => {
            const members = snap.val() || {};
            const userIds = Object.keys(members);
            
            roomMembers = new Set(userIds);
            memberCount.innerText = userIds.length;
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            membersContainer.innerHTML = '';
            userIds.forEach(uid => {
                const span = document.createElement('span');
                span.className = 'user-badge';
                span.innerText = uid + (uid === myUserId ? ' (—è)' : '');
                membersContainer.appendChild(span);
            });

            addLog(`—É—á–∞—Å—Ç–Ω–∏–∫–∏: ${userIds.join(', ') || '–Ω–∏–∫–æ–≥–æ'}`, 'info');

            // –°–æ–∑–¥–∞—ë–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            userIds.forEach(async (uid) => {
                if (uid === myUserId) return;
                
                if (!peerConnections.has(uid)) {
                    addLog(`–Ω–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ ${uid}, —Å–æ–∑–¥–∞—ë–º offer`, 'info');
                    
                    try {
                        const pc = await createPeerConnection(uid);
                        
                        // –°–æ–∑–¥–∞—ë–º offer
                        const offer = await pc.createOffer({
                            offerToReceiveAudio: true,
                            voiceActivityDetection: true
                        });
                        await pc.setLocalDescription(offer);
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º offer
                        await database.ref(`rooms/${roomId}/offers/${myUserId}/${uid}`).set(offer.toJSON());
                        addLog(`offer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è ${uid}`, 'success');
                        
                    } catch (err) {
                        addLog(`–æ—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer –¥–ª—è ${uid}: ${err.message}`, 'error');
                    }
                }
            });

            // –£–¥–∞–ª—è–µ–º –ø–∏—Ä—ã –≤—ã—à–µ–¥—à–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            for (let uid of peerConnections.keys()) {
                if (!userIds.includes(uid)) {
                    addLog(`—É—á–∞—Å—Ç–Ω–∏–∫ ${uid} –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É`, 'info');
                    try {
                        peerConnections.get(uid).close();
                        peerConnections.delete(uid);
                        const audioEl = document.getElementById(`audio_${uid}`);
                        if (audioEl) audioEl.remove();
                    } catch (err) {
                        addLog(`–æ—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–∏—Ä–∞ ${uid}: ${err.message}`, 'error');
                    }
                }
            }
            updatePeerCount();
        });

        // –°–ª—É—à–∞–µ–º offers
        const offersRef = database.ref(`rooms/${roomId}/offers`);
        offersListener = offersRef.on('child_added', (snap) => {
            const fromUser = snap.key;
            if (fromUser === myUserId) return;
            
            const offers = snap.val();
            if (offers && offers[myUserId]) {
                const offerData = offers[myUserId];
                addLog(`üìû –ø–æ–ª—É—á–µ–Ω offer –æ—Ç ${fromUser}`, 'info');
                
                (async () => {
                    try {
                        // –°–æ–∑–¥–∞—ë–º peer –µ—Å–ª–∏ –Ω–µ—Ç
                        if (!peerConnections.has(fromUser)) {
                            await createPeerConnection(fromUser);
                        }
                        
                        const pc = peerConnections.get(fromUser);
                        
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º remote description
                        await pc.setRemoteDescription(new RTCSessionDescription(offerData));
                        addLog(`remote description —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è ${fromUser}`, 'success');
                        
                        // –°–æ–∑–¥–∞—ë–º answer
                        const answer = await pc.createAnswer();
                        await pc.setLocalDescription(answer);
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º answer
                        await database.ref(`rooms/${roomId}/answers/${myUserId}/${fromUser}`).set(answer.toJSON());
                        addLog(`answer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è ${fromUser}`, 'success');
                        
                    } catch (err) {
                        addLog(`–æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ offer: ${err.message}`, 'error');
                    }
                })();
            }
        });

        // –°–ª—É—à–∞–µ–º answers
        const answersRef = database.ref(`rooms/${roomId}/answers`);
        answersListener = answersRef.on('child_added', (snap) => {
            const fromUser = snap.key;
            if (fromUser === myUserId) return;
            
            const answers = snap.val();
            if (answers && answers[myUserId]) {
                const answerData = answers[myUserId];
                addLog(`üìû –ø–æ–ª—É—á–µ–Ω answer –æ—Ç ${fromUser}`, 'info');
                
                (async () => {
                    try {
                        const pc = peerConnections.get(fromUser);
                        if (pc) {
                            await pc.setRemoteDescription(new RTCSessionDescription(answerData));
                            addLog(`remote answer —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è ${fromUser}`, 'success');
                        } else {
                            addLog(`–Ω–µ—Ç peer –¥–ª—è ${fromUser} –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ answer`, 'error');
                        }
                    } catch (err) {
                        addLog(`–æ—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ answer: ${err.message}`, 'error');
                    }
                })();
            }
        });

        // –°–ª—É—à–∞–µ–º candidates
        const candidatesRef = database.ref(`rooms/${roomId}/candidates`);
        candidatesListener = candidatesRef.on('child_added', (snap) => {
            const fromUser = snap.key;
            if (fromUser === myUserId) return;
            
            const candidates = snap.val();
            if (candidates && candidates[myUserId]) {
                // candidates[myUserId] –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º —Å –∫–ª—é—á–∞–º–∏
                Object.values(candidates[myUserId]).forEach(candidateData => {
                    const pc = peerConnections.get(fromUser);
                    if (pc) {
                        pc.addIceCandidate(new RTCIceCandidate(candidateData))
                            .then(() => addLog(`ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω –æ—Ç ${fromUser}`, 'info'))
                            .catch(err => addLog(`–æ—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE: ${err.message}`, 'error'));
                    }
                });
            }
        });

        addLog('‚úÖ —É—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç—É', 'success');
    }

    // ------------------------------------------------------------
    // –í—ã—Ö–æ–¥ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã
    async function leaveRoom() {
        if (!currentRoom) {
            addLog('–≤—ã –Ω–µ –≤ –∫–æ–º–Ω–∞—Ç–µ', 'warning');
            return;
        }

        const roomId = currentRoom;
        
        try {
            // –£–¥–∞–ª—è–µ–º —Å–µ–±—è –∏–∑ members
            await database.ref(`rooms/${roomId}/members/${myUserId}`).remove();
            
            // –£–¥–∞–ª—è–µ–º —Å–≤–æ–∏ —Å–∏–≥–Ω–∞–ª—ã
            await database.ref(`rooms/${roomId}/offers/${myUserId}`).remove();
            await database.ref(`rooms/${roomId}/answers/${myUserId}`).remove();
            await database.ref(`rooms/${roomId}/candidates/${myUserId}`).remove();
            
            // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —Å–ª—É—à–∞—Ç–µ–ª–µ–π
            if (membersListener) database.ref(`rooms/${roomId}/members`).off('value', membersListener);
            if (offersListener) database.ref(`rooms/${roomId}/offers`).off('child_added', offersListener);
            if (answersListener) database.ref(`rooms/${roomId}/answers`).off('child_added', answersListener);
            if (candidatesListener) database.ref(`rooms/${roomId}/candidates`).off('child_added', candidatesListener);
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–∏—Ä—ã
            await closeAllPeers();
            
            currentRoom = null;
            currentRoomSpan.innerText = '‚Äî';
            membersContainer.innerHTML = '<span class="status-badge">–Ω–µ—Ç –≤ –∫–æ–º–Ω–∞—Ç–µ</span>';
            memberCount.innerText = '0';
            
            addLog('üëã –≤—ã—à–ª–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã', 'success');
            
        } catch (err) {
            addLog(`–æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ: ${err.message}`, 'error');
        }
    }

    // ------------------------------------------------------------
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ –ø–∏—Ä–æ–≤
    function updatePeerCount() {
        let connected = 0;
        for (let pc of peerConnections.values()) {
            if (pc.connectionState === 'connected' || pc.iceConnectionState === 'connected') {
                connected++;
            }
        }
        peerCount.innerText = `${peerConnections.size} (${connected} connected)`;
        
        if (connected > 0) {
            peerStatus.className = 'connection-status status-green';
        } else if (peerConnections.size > 0) {
            peerStatus.className = 'connection-status status-yellow';
        } else {
            peerStatus.className = 'connection-status status-yellow';
        }
    }

    // ------------------------------------------------------------
    // Firebase —Å—Ç–∞—Ç—É—Å
    database.ref('.info/connected').on('value', (snap) => {
        if (snap.val()) {
            fbStatus.className = 'connection-status status-green';
            fbStatusText.innerText = '–ø–æ–¥–∫–ª—é—á–µ–Ω';
            addLog('Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω', 'success');
        } else {
            fbStatus.className = 'connection-status status-red';
            fbStatusText.innerText = '–æ—Ç–∫–ª—é—á–µ–Ω';
            addLog('Firebase –æ—Ç–∫–ª—é—á–µ–Ω', 'error');
        }
    });

    // ------------------------------------------------------------
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
    joinBtn.addEventListener('click', () => {
        const room = roomIdInput.value.trim();
        joinRoom(room);
    });

    leaveBtn.addEventListener('click', leaveRoom);

    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
    window.addEventListener('beforeunload', () => {
        if (currentRoom) {
            database.ref(`rooms/${currentRoom}/members/${myUserId}`).remove();
        }
    });

    // ------------------------------------------------------------
    // –°—Ç–∞—Ä—Ç
    addLog(`–≤–∞—à ID: ${myUserId}`, 'info');
</script>
</body>
</html>