<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=yes">
    <title>Skype ¬∑ –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Segoe UI WP', 'Segoe UI Symbol', 'Helvetica Neue', sans-serif;
            background: #1b1f24;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            position: relative;
        }

        .log-toggle-btn {
            position: fixed;
            left: 20px;
            bottom: 20px;
            width: 48px;
            height: 48px;
            background: #2d2d2d;
            border: 2px solid #404040;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .log-toggle-btn:hover {
            background: #3d3d3d;
        }

        .log-toggle-btn.active {
            background: #00aff0;
            border-color: #008fc0;
        }

        .log-panel {
            position: fixed;
            left: 20px;
            bottom: 78px;
            width: 500px;
            max-width: calc(100vw - 40px);
            background: #1b1f24;
            border: 2px solid #333333;
            color: #e0e0e0;
            font-family: 'Segoe UI', monospace;
            font-size: 13px;
            z-index: 999;
            display: none;
        }

        .log-panel.visible {
            display: block;
        }

        .log-header {
            background: #2d2d2d;
            padding: 10px 15px;
            border-bottom: 2px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-header span {
            color: white;
            font-weight: 300;
            text-transform: uppercase;
            font-size: 14px;
        }

        .log-close {
            background: none;
            border: 2px solid #555555;
            color: white;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .log-content {
            height: 250px;
            overflow-y: auto;
            padding: 10px;
        }

        .log-line {
            padding: 4px 0;
            border-bottom: 1px solid #333333;
            color: #cccccc;
            font-family: 'Segoe UI', monospace;
            font-size: 12px;
            word-break: break-word;
        }

        .log-line.error { color: #ff8a8a; }
        .log-line.success { color: #90e090; }

        .log-controls {
            display: flex;
            gap: 2px;
            padding: 10px;
            background: #2d2d2d;
            border-top: 2px solid #404040;
        }

        .log-btn {
            background: #3a3a3a;
            border: 2px solid #4a4a4a;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            font-size: 12px;
            font-weight: 300;
            padding: 8px;
            cursor: pointer;
            flex: 1;
            text-align: center;
            text-transform: uppercase;
        }

        .metro-container {
            width: 1100px;
            max-width: 100%;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            box-shadow: none;
            border: none;
            margin: 0 auto;
        }

        .metro-header {
            background: #00aff0;
            min-height: 60px;
            display: flex;
            align-items: center;
            padding: 10px 20px;
            color: white;
            font-size: 24px;
            font-weight: 300;
            flex-wrap: wrap;
            gap: 10px;
        }

        .metro-header span {
            font-weight: 300;
            text-transform: lowercase;
        }

        .metro-header .header-status {
            margin-left: auto;
            font-size: 14px;
            font-weight: 300;
            opacity: 0.9;
            white-space: nowrap;
        }

        .metro-grid {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            min-height: 600px;
        }

        .metro-tile-profile {
            width: 320px;
            max-width: 100%;
            background: #f0f0f0;
            border-right: 2px solid #d0d0d0;
            padding: 0;
        }

        .metro-tile-logs {
            flex: 1;
            min-width: 300px;
            background: #ffffff;
            display: flex;
            flex-direction: column;
        }

        .tile {
            background: #00aff0;
            color: white;
            padding: 20px 15px;
            margin: 0;
            border-bottom: 2px solid #008fc0;
        }

        .tile-title {
            font-size: 14px;
            font-weight: 300;
            text-transform: uppercase;
            opacity: 0.8;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .tile-content {
            font-size: 22px;
            font-weight: 300;
            word-break: break-all;
            font-family: 'Segoe UI', monospace;
        }

        .tile-content-small {
            font-size: 14px;
            font-weight: 300;
            opacity: 0.9;
        }

        .tile-room {
            background: #2d2d2d;
            color: white;
            padding: 20px 15px;
            border-bottom: 2px solid #404040;
        }

        .metro-input {
            background: #3a3a3a;
            border: 2px solid #555555;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            font-size: 16px;
            padding: 12px;
            width: 100%;
            margin: 8px 0;
            outline: none;
            font-weight: 300;
            -webkit-appearance: none;
            border-radius: 0;
        }

        .metro-input:focus {
            border-color: #00aff0;
            background: #454545;
        }

        .metro-btn {
            background: #00aff0;
            border: 2px solid #008fc0;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            font-size: 16px;
            font-weight: 300;
            padding: 12px 15px;
            margin: 4px 0;
            width: 100%;
            cursor: pointer;
            text-align: left;
            transition: background 0.1s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            -webkit-appearance: none;
            border-radius: 0;
        }

        .metro-btn:hover {
            background: #1fc2ff;
        }

        .metro-btn:active {
            background: #008fc0;
        }

        .metro-btn-green {
            background: #00b050;
            border-color: #009040;
        }

        .metro-btn-red {
            background: #e81123;
            border-color: #c01120;
        }

        .tile-members {
            background: #f0f0f0;
            color: #1b1f24;
            padding: 20px 15px;
            border-bottom: 2px solid #d0d0d0;
        }

        .members-list {
            display: flex;
            flex-wrap: wrap;
            margin-top: 10px;
            gap: 6px;
        }

        .member-badge-metro {
            background: #00aff0;
            color: white;
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 300;
            border: 2px solid #008fc0;
            display: inline-block;
            word-break: break-word;
        }

        .status-bar-metro {
            background: #1b1f24;
            color: white;
            padding: 12px 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            border-bottom: 2px solid #333333;
            font-weight: 300;
        }

        .status-item {
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: #f1c40f;
            margin-right: 8px;
            border: none;
            flex-shrink: 0;
        }

        .status-dot.green { background: #00b050; }
        .status-dot.red { background: #e81123; }
        .status-dot.yellow { background: #f1c40f; }
        .status-dot.gray { background: #7e7e7e; }

        .right-content {
            flex: 1;
            background: #f5f5f5;
            min-height: 200px;
        }

        .audio-test-btn {
            background: #3a3a3a;
            border: 2px solid #555555;
            color: white;
            padding: 10px;
            margin-top: 10px;
            cursor: pointer;
            width: 100%;
            text-align: center;
            font-weight: 300;
        }

        .audio-test-btn:hover {
            background: #4a4a4a;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
                align-items: flex-start;
            }

            .metro-grid {
                flex-direction: column;
            }

            .metro-tile-profile {
                width: 100%;
                border-right: none;
                border-bottom: 2px solid #d0d0d0;
            }

            .metro-tile-logs {
                width: 100%;
            }

            .metro-header {
                font-size: 20px;
                padding: 10px 15px;
            }

            .metro-header .header-status {
                font-size: 12px;
                white-space: normal;
            }

            .tile-content {
                font-size: 18px;
            }

            .status-bar-metro {
                gap: 10px;
            }

            .status-item {
                font-size: 12px;
            }

            .log-toggle-btn {
                left: 10px;
                bottom: 10px;
                width: 44px;
                height: 44px;
                font-size: 18px;
            }

            .log-panel {
                left: 10px;
                bottom: 64px;
                max-width: calc(100vw - 20px);
            }

            .log-content {
                height: 200px;
            }
        }

        @media (max-width: 480px) {
            .status-bar-metro {
                flex-direction: column;
                gap: 8px;
            }
            
            .member-badge-metro {
                font-size: 12px;
                padding: 4px 8px;
            }
            
            .metro-btn {
                font-size: 14px;
                padding: 10px 12px;
            }
        }
    </style>
</head>
<body>
    <button class="log-toggle-btn" id="logToggleBtn" title="–ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏">üìã</button>

    <div class="log-panel" id="logPanel">
        <div class="log-header">
            <span>—Å–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏</span>
            <button class="log-close" id="logCloseBtn">‚úï</button>
        </div>
        <div class="log-content" id="logContent">
            <div class="log-line">[system] –∑–∞–ø—É—Å–∫...</div>
        </div>
        <div class="log-controls">
            <button class="log-btn" id="copyLogsBtn">–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="log-btn" id="clearLogsBtn">–æ—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
    </div>

    <div class="metro-container">
        <div class="metro-header">
            <span>skype</span>
            <div class="header-status" id="fbStatusText">–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
        </div>

        <div class="metro-grid">
            <div class="metro-tile-profile">
                <div class="tile">
                    <div class="tile-title">–º–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä</div>
                    <div class="tile-content" id="myUserId">–∑–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div class="tile-content-small" style="margin-top: 8px;">–ø–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–∏–º id</div>
                </div>

                <div class="tile-room">
                    <div class="tile-title">–∫–æ–º–Ω–∞—Ç–∞</div>
                    <input type="text" id="roomInput" class="metro-input" placeholder="id –∫–æ–º–Ω–∞—Ç—ã" value="testroom">
                    
                    <button class="metro-btn metro-btn-green" id="joinBtn">–≤–æ–π—Ç–∏</button>
                    <button class="metro-btn metro-btn-red" id="leaveBtn">–ø–æ–∫–∏–Ω—É—Ç—å</button>
                    <button class="metro-btn" id="testMicBtn">—Ç–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</button>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≤–∫–ª—é—á–µ–Ω–∏—è –∑–≤—É–∫–∞ -->
                    <button class="audio-test-btn" id="forceAudioBtn">üîä –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>
                </div>

                <div class="tile-members">
                    <div class="tile-title">—É—á–∞—Å—Ç–Ω–∏–∫–∏ (<span id="memberCount">0</span>/4)</div>
                    <div id="membersList" class="members-list"></div>
                    <div style="margin-top: 15px; font-weight: 300;">
                        <span class="metro-text-small">—Ç–µ–∫—É—â–∞—è: </span>
                        <span id="currentRoom" style="font-weight: 300;">‚Äî</span>
                    </div>
                </div>
            </div>

            <div class="metro-tile-logs">
                <div class="status-bar-metro">
                    <div class="status-item">
                        <div class="status-dot" id="fbStatus"></div>
                        <span>firebase</span>
                    </div>
                    <div class="status-item">
                        <div class="status-dot" id="micStatus"></div>
                        <span>–º–∏–∫—Ä–æ—Ñ–æ–Ω</span>
                    </div>
                    <div class="status-item">
                        <div class="status-dot" id="peerStatus"></div>
                        <span>–ø–∏—Ä—ã: <span id="peerCount">0</span></span>
                    </div>
                </div>
                <div class="right-content"></div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDTx2Y9ctiWp26YeMmAHAxDZd_gVI_ZMdw",
            authDomain: "kcalls.firebaseapp.com",
            databaseURL: "https://kcalls-default-rtdb.firebaseio.com",
            projectId: "kcalls",
            storageBucket: "kcalls.firebasestorage.app",
            messagingSenderId: "990117089104",
            appId: "1:990117089104:web:278a42c037e975ebb76655"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const myUserId = 'user_' + Math.random().toString(36).substring(2, 8);
        document.getElementById('myUserId').innerText = myUserId;

        let localStream = null;
        let peers = new Map();
        let currentRoom = null;
        let processingOffers = new Set();
        let isInRoom = false;
        let cleanupInterval = null;
        let statusInterval = null;
        
        // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –∞—É–¥–∏–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤
        let audioElements = new Map();

        const logPanel = document.getElementById('logPanel');
        const logContent = document.getElementById('logContent');
        const logToggleBtn = document.getElementById('logToggleBtn');
        const logCloseBtn = document.getElementById('logCloseBtn');
        const membersList = document.getElementById('membersList');
        const currentRoomSpan = document.getElementById('currentRoom');
        const roomInput = document.getElementById('roomInput');
        const joinBtn = document.getElementById('joinBtn');
        const leaveBtn = document.getElementById('leaveBtn');
        const testMicBtn = document.getElementById('testMicBtn');
        const copyLogsBtn = document.getElementById('copyLogsBtn');
        const clearLogsBtn = document.getElementById('clearLogsBtn');
        const memberCount = document.getElementById('memberCount');
        const peerCount = document.getElementById('peerCount');
        const forceAudioBtn = document.getElementById('forceAudioBtn');
        
        const fbStatus = document.getElementById('fbStatus');
        const fbStatusText = document.getElementById('fbStatusText');
        const micStatus = document.getElementById('micStatus');
        const peerStatus = document.getElementById('peerStatus');

        // ------------------------------------------------------------
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∞—É–¥–∏–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤
        async function forcePlayAllAudio() {
            log('–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ –∑–≤—É–∫–∞...', 'info');
            
            for (let [userId, audio] of audioElements) {
                try {
                    await audio.play();
                    log(`–∑–≤—É–∫ –≤–∫–ª—é—á–µ–Ω –¥–ª—è ${userId}`, 'success');
                } catch (err) {
                    log(`–æ—à–∏–±–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è –∑–≤—É–∫–∞ –¥–ª—è ${userId}: ${err.message}`, 'error');
                    
                    // –ü—Ä–æ–±—É–µ–º –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∞—É–¥–∏–æ—ç–ª–µ–º–µ–Ω—Ç
                    if (peers.has(userId)) {
                        const pc = peers.get(userId);
                        if (pc.getReceivers) {
                            const receivers = pc.getReceivers();
                            receivers.forEach(receiver => {
                                if (receiver.track && receiver.track.kind === 'audio') {
                                    const newAudio = new Audio();
                                    newAudio.srcObject = new MediaStream([receiver.track]);
                                    newAudio.autoplay = true;
                                    newAudio.style.display = 'none';
                                    document.body.appendChild(newAudio);
                                    
                                    audioElements.set(userId, newAudio);
                                    newAudio.play().catch(e => log(`–ø–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—à–∏–±–∫–∞: ${e.message}`, 'error'));
                                }
                            });
                        }
                    }
                }
            }
        }

        forceAudioBtn.addEventListener('click', forcePlayAllAudio);

        // ------------------------------------------------------------
        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–≤—É–∫–∞ (–∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞)
        function startAudioCheck() {
            setInterval(() => {
                if (isInRoom && audioElements.size > 0) {
                    audioElements.forEach((audio, userId) => {
                        if (audio.paused) {
                            log(`–∞—É–¥–∏–æ –¥–ª—è ${userId} –Ω–∞ –ø–∞—É–∑–µ, –ø—Ä–æ–±—É–µ–º –≤–∫–ª—é—á–∏—Ç—å`, 'warning');
                            audio.play().catch(err => log(`–æ—à–∏–±–∫–∞: ${err.message}`, 'error'));
                        }
                    });
                }
            }, 2000);
        }

        // ------------------------------------------------------------
        logToggleBtn.addEventListener('click', () => {
            logPanel.classList.toggle('visible');
            logToggleBtn.classList.toggle('active');
        });

        logCloseBtn.addEventListener('click', () => {
            logPanel.classList.remove('visible');
            logToggleBtn.classList.remove('active');
        });

        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const line = document.createElement('div');
            line.className = 'log-line';
            if (type === 'error') line.classList.add('error');
            if (type === 'success') line.classList.add('success');
            
            let prefix = '';
            if (type === 'error') prefix = 'ERROR: ';
            else if (type === 'success') prefix = 'OK: ';
            else if (type === 'warning') prefix = 'WARNING: ';
            
            line.innerHTML = `[${time}] ${prefix}${message}`;
            logContent.appendChild(line);
            logContent.scrollTop = logContent.scrollHeight;
            
            if (type === 'error') console.error(message);
            else console.log(message);
        }

        clearLogsBtn.addEventListener('click', () => {
            logContent.innerHTML = '<div class="log-line">[system] –ª–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã</div>';
        });

        copyLogsBtn.addEventListener('click', () => {
            let text = '';
            document.querySelectorAll('#logContent .log-line').forEach(div => {
                text += div.innerText + '\n';
            });
            navigator.clipboard.writeText(text).then(() => {
                log('–ª–æ–≥–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã', 'success');
            });
        });

        async function initMic(force = false) {
            if (localStream && !force) {
                micStatus.className = 'status-dot green';
                return localStream;
            }
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                micStatus.className = 'status-dot red';
                log('getUserMedia –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (–Ω—É–∂–µ–Ω HTTPS)', 'error');
                throw new Error('getUserMedia not supported');
            }
            
            try {
                micStatus.className = 'status-dot yellow';
                log('–∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω...');
                
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                micStatus.className = 'status-dot green';
                log('–º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–ª—É—á–µ–Ω', 'success');
                
                localStream.getTracks().forEach(track => {
                    log(`—Ç—Ä–µ–∫ ${track.kind}: enabled=${track.enabled}`, 'info');
                });
                
                return localStream;
                
            } catch (err) {
                micStatus.className = 'status-dot red';
                
                let msg = '–æ—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: ';
                if (err.name === 'NotAllowedError') msg += '–¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω';
                else if (err.name === 'NotFoundError') msg += '–º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω';
                else msg += err.message;
                
                log(msg, 'error');
                throw err;
            }
        }

        testMicBtn.addEventListener('click', async () => {
            try {
                await initMic(true);
                log('—Ç–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ —É—Å–ø–µ—à–µ–Ω', 'success');
            } catch (err) {
                log('—Ç–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω', 'error');
            }
        });

        async function createPeer(targetId) {
            if (peers.has(targetId)) {
                log(`–∑–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –ø–∏—Ä ${targetId}`, 'warning');
                try {
                    peers.get(targetId).close();
                } catch (err) {}
                peers.delete(targetId);
            }

            if (!localStream) {
                log('–Ω–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞, –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å', 'warning');
                try { await initMic(); } catch (err) {}
            }

            const pc = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            });

            if (localStream) {
                localStream.getTracks().forEach(track => {
                    try {
                        pc.addTrack(track, localStream);
                        log(`—Ç—Ä–µ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è ${targetId}`, 'info');
                    } catch (err) {
                        log(`–æ—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–∞: ${err.message}`, 'error');
                    }
                });
            }

            pc.onicecandidate = (e) => {
                if (e.candidate && currentRoom) {
                    const path = `rooms/${currentRoom}/candidates/${myUserId}/${targetId}`;
                    db.ref(path).push(e.candidate.toJSON())
                        .catch(err => log(`–æ—à–∏–±–∫–∞ ICE: ${err.message}`, 'error'));
                }
            };

            pc.ontrack = (e) => {
                log(`–ø–æ–ª—É—á–µ–Ω –∞—É–¥–∏–æ—Ç—Ä–µ–∫ –æ—Ç ${targetId}`, 'success');
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∞—É–¥–∏–æ—ç–ª–µ–º–µ–Ω—Ç
                const audio = new Audio();
                audio.id = `audio_${targetId}`;
                audio.autoplay = true;
                audio.style.display = 'none';
                
                // –í–∞–∂–Ω–æ: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º srcObject –¥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ DOM
                audio.srcObject = e.streams[0];
                
                // –ü—Ä–æ–±—É–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Å—Ä–∞–∑—É
                audio.play()
                    .then(() => log(`–∞—É–¥–∏–æ –æ—Ç ${targetId} –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è`, 'success'))
                    .catch(err => {
                        log(`–æ—à–∏–±–∫–∞ –∞–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –¥–ª—è ${targetId}: ${err.message}`, 'warning');
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                    });
                
                document.body.appendChild(audio);
                audioElements.set(targetId, audio);
                
                // –ü—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
                setTimeout(() => {
                    if (audio.paused) {
                        audio.play().catch(err => log(`–ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞: ${err.message}`, 'warning'));
                    }
                }, 1000);
            };

            pc.oniceconnectionstatechange = () => {
                log(`ice ${targetId}: ${pc.iceConnectionState}`, 'info');
                if (pc.iceConnectionState === 'connected') {
                    // –ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–æ–±—É–µ–º –≤–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫
                    setTimeout(forcePlayAllAudio, 500);
                }
                updatePeerStats();
            };

            pc.onconnectionstatechange = () => {
                log(`conn ${targetId}: ${pc.connectionState}`, 'info');
                updatePeerStats();
            };

            peers.set(targetId, pc);
            updatePeerStats();
            return pc;
        }

        async function closeAllPeers() {
            for (let [id, pc] of peers) {
                try {
                    pc.close();
                    let audio = audioElements.get(id);
                    if (audio) {
                        audio.pause();
                        audio.remove();
                        audioElements.delete(id);
                    }
                } catch (err) {
                    log(`–æ—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–∏—Ä–∞ ${id}: ${err.message}`, 'error');
                }
            }
            peers.clear();
            updatePeerStats();
            log('–≤—Å–µ –ø–∏—Ä—ã –∑–∞–∫—Ä—ã—Ç—ã', 'info');
        }

        function shouldCreateOffer(remoteId) {
            return myUserId < remoteId;
        }

        function updatePeerStats() {
            let connected = 0;
            for (let pc of peers.values()) {
                if (pc.connectionState === 'connected' || pc.iceConnectionState === 'connected') {
                    connected++;
                }
            }
            peerCount.innerText = `${peers.size} (${connected} —Å–æ–µ–¥.)`;
            
            if (connected > 0) {
                peerStatus.className = 'status-dot green';
            } else if (peers.size > 0) {
                peerStatus.className = 'status-dot yellow';
            } else {
                peerStatus.className = 'status-dot gray';
            }
        }

        function startCleanupTimer(roomId) {
            if (cleanupInterval) clearInterval(cleanupInterval);
            
            cleanupInterval = setInterval(async () => {
                if (!isInRoom || !roomId) return;
                
                try {
                    const snapshot = await db.ref(`rooms/${roomId}/members`).once('value');
                    const members = snapshot.val() || {};
                    const now = Date.now();
                    
                    for (const [uid, data] of Object.entries(members)) {
                        if (data.joined && now - data.joined > 15000) {
                            if (uid !== myUserId) {
                                log(`—É–¥–∞–ª—è–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ ${uid}`, 'warning');
                                await db.ref(`rooms/${roomId}/members/${uid}`).remove();
                                await db.ref(`rooms/${roomId}/offers/${uid}`).remove();
                                await db.ref(`rooms/${roomId}/answers/${uid}`).remove();
                                await db.ref(`rooms/${roomId}/candidates/${uid}`).remove();
                            }
                        }
                    }
                } catch (err) {
                    log(`–æ—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏: ${err.message}`, 'error');
                }
            }, 5000);
        }

        async function joinRoom(roomId) {
            if (!roomId) { log('–≤–≤–µ–¥–∏—Ç–µ id –∫–æ–º–Ω–∞—Ç—ã', 'error'); return; }
            
            if (currentRoom) {
                log('—Å–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∏–¥–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–æ–º–Ω–∞—Ç—É', 'warning');
                await leaveRoom();
            }

            await initMic().catch(() => {});

            currentRoom = roomId;
            isInRoom = true;
            currentRoomSpan.innerText = roomId;
            log(`–≤—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É: ${roomId}`, 'info');

            await db.ref(`rooms/${roomId}/members/${myUserId}`).set({
                joined: Date.now()
            });

            startCleanupTimer(roomId);
            
            if (statusInterval) clearInterval(statusInterval);
            statusInterval = setInterval(() => {
                if (currentRoom && isInRoom) {
                    db.ref(`rooms/${currentRoom}/members/${myUserId}`).update({
                        joined: Date.now()
                    });
                }
            }, 5000);

            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∑–≤—É–∫–∞
            startAudioCheck();

            db.ref(`rooms/${roomId}/members`).on('value', (snap) => {
                if (!isInRoom) return;
                
                const members = snap.val() || {};
                const now = Date.now();
                
                const activeMembers = {};
                for (const [uid, data] of Object.entries(members)) {
                    if (data.joined && now - data.joined <= 20000) {
                        activeMembers[uid] = data;
                    }
                }
                
                const userIds = Object.keys(activeMembers);
                
                memberCount.innerText = userIds.length;
                
                membersList.innerHTML = '';
                userIds.forEach(uid => {
                    const span = document.createElement('span');
                    span.className = 'member-badge-metro';
                    span.innerText = uid + (uid === myUserId ? ' (—è)' : '');
                    membersList.appendChild(span);
                });

                log(`—É—á–∞—Å—Ç–Ω–∏–∫–∏: ${userIds.join(', ') || '–Ω–∏–∫–æ–≥–æ'}`, 'info');

                userIds.forEach(async (uid) => {
                    if (uid === myUserId || !isInRoom) return;
                    
                    if (!peers.has(uid) && shouldCreateOffer(uid)) {
                        log(`–Ω–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ ${uid}, —Å–æ–∑–¥–∞—é offer (—è –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä)`, 'info');
                        
                        try {
                            const pc = await createPeer(uid);
                            
                            const offer = await pc.createOffer({
                                offerToReceiveAudio: true
                            });
                            await pc.setLocalDescription(offer);
                            
                            await db.ref(`rooms/${roomId}/offers/${myUserId}/${uid}`).set({
                                type: offer.type,
                                sdp: offer.sdp
                            });
                            log(`offer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è ${uid}`, 'success');
                            
                        } catch (err) {
                            log(`–æ—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer: ${err.message}`, 'error');
                        }
                    } else if (!peers.has(uid)) {
                        log(`–∂–¥—É offer –æ—Ç ${uid} (–æ–Ω –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä)`, 'info');
                    }
                });

                for (let uid of peers.keys()) {
                    if (!userIds.includes(uid)) {
                        log(`—É—á–∞—Å—Ç–Ω–∏–∫ ${uid} –≤—ã—à–µ–ª`, 'info');
                        try {
                            peers.get(uid).close();
                            peers.delete(uid);
                            let audio = audioElements.get(uid);
                            if (audio) {
                                audio.pause();
                                audio.remove();
                                audioElements.delete(uid);
                            }
                        } catch (err) {
                            log(`–æ—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–∏—Ä–∞: ${err.message}`, 'error');
                        }
                    }
                }
                updatePeerStats();
            });

            db.ref(`rooms/${roomId}/offers`).on('child_added', (snap) => {
                if (!isInRoom) return;
                
                const fromUser = snap.key;
                if (fromUser === myUserId) return;
                if (processingOffers.has(fromUser)) return;
                
                const offers = snap.val();
                if (offers && offers[myUserId]) {
                    const offerData = offers[myUserId];
                    log(`–ø–æ–ª—É—á–µ–Ω offer –æ—Ç ${fromUser}`, 'info');
                    processingOffers.add(fromUser);
                    
                    (async () => {
                        try {
                            if (!peers.has(fromUser)) {
                                await createPeer(fromUser);
                            }
                            
                            const pc = peers.get(fromUser);
                            if (pc.signalingState === 'stable') {
                                await pc.setRemoteDescription(new RTCSessionDescription(offerData));
                                log(`remote description —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è ${fromUser}`, 'success');
                                
                                const answer = await pc.createAnswer();
                                await pc.setLocalDescription(answer);
                                
                                await db.ref(`rooms/${roomId}/answers/${myUserId}/${fromUser}`).set({
                                    type: answer.type,
                                    sdp: answer.sdp
                                });
                                log(`answer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è ${fromUser}`, 'success');
                            }
                            
                        } catch (err) {
                            log(`–æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ offer: ${err.message}`, 'error');
                        } finally {
                            processingOffers.delete(fromUser);
                        }
                    })();
                }
            });

            db.ref(`rooms/${roomId}/answers`).on('child_added', (snap) => {
                if (!isInRoom) return;
                
                const fromUser = snap.key;
                if (fromUser === myUserId) return;
                
                const answers = snap.val();
                if (answers && answers[myUserId]) {
                    const answerData = answers[myUserId];
                    log(`–ø–æ–ª—É—á–µ–Ω answer –æ—Ç ${fromUser}`, 'info');
                    
                    (async () => {
                        try {
                            const pc = peers.get(fromUser);
                            if (pc && pc.signalingState === 'have-local-offer') {
                                await pc.setRemoteDescription(new RTCSessionDescription(answerData));
                                log(`remote answer —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è ${fromUser}`, 'success');
                            }
                        } catch (err) {
                            log(`–æ—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ answer: ${err.message}`, 'error');
                        }
                    })();
                }
            });

            db.ref(`rooms/${roomId}/candidates`).on('child_added', (snap) => {
                if (!isInRoom) return;
                
                const fromUser = snap.key;
                if (fromUser === myUserId) return;
                
                const candidates = snap.val();
                if (candidates && candidates[myUserId]) {
                    Object.values(candidates[myUserId]).forEach(candidateData => {
                        const pc = peers.get(fromUser);
                        if (pc && pc.remoteDescription) {
                            pc.addIceCandidate(new RTCIceCandidate(candidateData))
                                .catch(err => log(`–æ—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ice: ${err.message}`, 'error'));
                        }
                    });
                }
            });

            log('—É—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç—É', 'success');
        }

        async function leaveRoom() {
            if (!currentRoom) {
                log('–≤—ã –Ω–µ –≤ –∫–æ–º–Ω–∞—Ç–µ', 'warning');
                return;
            }

            const roomId = currentRoom;
            isInRoom = false;
            
            if (cleanupInterval) {
                clearInterval(cleanupInterval);
                cleanupInterval = null;
            }
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
            
            try {
                await db.ref(`rooms/${roomId}/members/${myUserId}`).remove();
                await db.ref(`rooms/${roomId}/offers/${myUserId}`).remove();
                await db.ref(`rooms/${roomId}/answers/${myUserId}`).remove();
                await db.ref(`rooms/${roomId}/candidates/${myUserId}`).remove();
                
                db.ref(`rooms/${roomId}/members`).off();
                db.ref(`rooms/${roomId}/offers`).off();
                db.ref(`rooms/${roomId}/answers`).off();
                db.ref(`rooms/${roomId}/candidates`).off();
                
                await closeAllPeers();
                processingOffers.clear();
                
                currentRoom = null;
                currentRoomSpan.innerText = '‚Äî';
                membersList.innerHTML = '';
                memberCount.innerText = '0';
                
                log('–≤—ã—à–ª–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã', 'success');
                
            } catch (err) {
                log(`–æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ: ${err.message}`, 'error');
            }
        }

        db.ref('.info/connected').on('value', (snap) => {
            if (snap.val()) {
                fbStatus.className = 'status-dot green';
                fbStatusText.innerText = '–ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
                log('firebase –ø–æ–¥–∫–ª—é—á–µ–Ω', 'success');
            } else {
                fbStatus.className = 'status-dot red';
                fbStatusText.innerText = '–æ—Ç–∫–ª—é—á–µ–Ω–æ';
                log('firebase –æ—Ç–∫–ª—é—á–µ–Ω', 'error');
            }
        });

        joinBtn.addEventListener('click', () => {
            joinRoom(roomInput.value.trim());
        });

        leaveBtn.addEventListener('click', leaveRoom);

        window.addEventListener('beforeunload', () => {
            if (currentRoom) {
                db.ref(`rooms/${currentRoom}/members/${myUserId}`).remove();
            }
            if (cleanupInterval) {
                clearInterval(cleanupInterval);
            }
            if (statusInterval) {
                clearInterval(statusInterval);
            }
        });

        log(`–≤–∞—à id: ${myUserId}`, 'info');
    </script>
</body>
</html>